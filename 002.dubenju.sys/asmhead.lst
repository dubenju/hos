     1 00000000                                 ; asm head
     2 00000000                                 ; TAB=4
     3 00000000                                 
     4 00000000                                 [INSTRSET "i486p"]				; 486の命令まで使いたいという記述
     5 00000000                                 
     6  = 00000111                              VBEMODE EQU 0x111
     7 00000000                                 ;  0x100 :  640 x  400 x 8bit Color
     8 00000000                                 ;  0x101 :  640 x  480 x 8bit Color
     9 00000000                                 ;  0x103 :  800 x  600 x 8bit Color
    10 00000000                                 ;  0x105 : 1024 x  768 x 8bit Color
    11 00000000                                 ;  0x107 : 1280 x 1024 x 8bit Color
    12 00000000                                 
    13 00000000                                 ;  0x111 :  640 x  480 x 16bit Color5:6:5
    14 00000000                                 ;  0x112 :  640 x  480 x 24bit Color8:8:8
    15 00000000                                 ;  0x114 :  800 x  600 x 16bit Color5:6:5
    16 00000000                                 ;  0x115 :  800 x  600 x 24bit Color8:8:8
    17 00000000                                 ;  0x117 : 1024 x  768 x 16bit Color5:6:5
    18 00000000                                 ;  0x118 : 1024 x  768 x 24bit Color8:8:8
    19 00000000                                 ;  0x11A : 1280 x 1024 x 16bit Color5:6:5
    20 00000000                                 ;  0x11B : 1280 x 1024 x 24bit Color8:8:8
    21 00000000                                 
    22 00000000                                 ;#00083
    23 00000000                                 ;Values for VESA video mode:
    24 00000000                                 ; 00h-FFh OEM video modes (see #00010 at AH=00h)
    25 00000000                                 ; 100h	640x400x256
    26 00000000                                 ; 101h	640x480x256
    27 00000000                                 ; 102h	800x600x16
    28 00000000                                 ; 103h	800x600x256
    29 00000000                                 ; 104h	1024x768x16
    30 00000000                                 ; 105h	1024x768x256
    31 00000000                                 ; 106h	1280x1024x16
    32 00000000                                 ; 107h	1280x1024x256
    33 00000000                                 ; 108h	80x60 text
    34 00000000                                 ; 109h	132x25 text
    35 00000000                                 ; 10Ah	132x43 text
    36 00000000                                 ; 10Bh	132x50 text
    37 00000000                                 ; 10Ch	132x60 text
    38 00000000                                 ;---VBE v1.2+ ---
    39 00000000                                 ; 10Dh	320x200x32K
    40 00000000                                 ; 10Eh	320x200x64K
    41 00000000                                 ; 10Fh	320x200x16M
    42 00000000                                 ; 110h	640x480x32K
    43 00000000                                 ; 111h	640x480x64K
    44 00000000                                 ; 112h	640x480x16M
    45 00000000                                 ; 113h	800x600x32K
    46 00000000                                 ; 114h	800x600x64K
    47 00000000                                 ; 115h	800x600x16M
    48 00000000                                 ; 116h	1024x768x32K
    49 00000000                                 ; 117h	1024x768x64K
    50 00000000                                 ; 118h	1024x768x16M
    51 00000000                                 ; 119h	1280x1024x32K (1:5:5:5)
    52 00000000                                 ; 11Ah	1280x1024x64K (5:6:5)
    53 00000000                                 ; 11Bh	1280x1024x16M
    54 00000000                                 ;---VBE 2.0+ ---
    55 00000000                                 ; 120h	1600x1200x256
    56 00000000                                 ; 121h	1600x1200x32K
    57 00000000                                 ; 122h	1600x1200x64K
    58 00000000                                 ;81FFh	special full-memory access mode
    59 00000000                                 ;Notes:	the special mode 81FFh preserves the contents of the video memory and
    60 00000000                                 ;	  gives access to all of the memory; VESA recommends that the special
    61 00000000                                 ;	  mode be a packed-pixel mode.	For VBE 2.0+, it is required that the
    62 00000000                                 ;	  VBE implement the mode, but not place it in the list of available
    63 00000000                                 ;	  modes (mode information for this mode can be queried directly,
    64 00000000                                 ;	  however).
    65 00000000                                 ;	as of VBE 2.0, VESA will no longer define video mode numbers
    66 00000000                                 
    67 00000000                                 
    68  = 00280000                              BOTPAK	EQU		0x00280000		; bootpackのロード先
    69  = 00100000                              DSKCAC	EQU		0x00100000		; ディスクキャッシュの場所
    70  = 00000900                              DSKCAC0	EQU		0x00000900		; ディスクキャッシュの場所（リアルモード）
    71 00000000                                 
    72 00000000                                 ; BOOT_INFO関係
    73  = 000005F0                              CYLS	EQU		0x05f0			; ブートセクタが設定する
    74  = 000005F1                              LEDS	EQU		0x05f1
    75  = 000005F2                              VMODE	EQU		0x05f2			; 色数に関する情報。何ビットカラーか？
    76  = 000005F4                              SCRNX	EQU		0x05f4			; 解像度のX
    77  = 000005F6                              SCRNY	EQU		0x05f6			; 解像度のY
    78  = 000005F8                              VRAM	EQU		0x05f8			; グラフィックバッファの開始番地
    79 00000000                                 
    80                                          		ORG		0x7F00
    81 00007F00 C6 06 05F0 01                   		MOV		BYTE  [CYLS],1 
    82 00007F05                                 
    83 00007F05                                 ;INT 10 - VESA SuperVGA BIOS (VBE) - GET SuperVGA INFORMATION
    84 00007F05                                 ;	AX = 4F00h
    85 00007F05                                 ;	ES:DI -> buffer for SuperVGA information (see #00077)
    86 00007F05                                 ;Return: AL = 4Fh if function supported
    87 00007F05                                 ;	AH = status
    88 00007F05                                 ;	    00h successful
    89 00007F05                                 ;		ES:DI buffer filled
    90 00007F05                                 ;	    01h failed
    91 00007F05                                 ;	    ---VBE v2.0---
    92 00007F05                                 ;	    02h function not supported by current hardware configuration
    93 00007F05                                 ;	    03h function invalid in current video mode
    94 00007F05                                 ;Desc:	determine whether VESA BIOS extensions are present and the capabilities
    95 00007F05                                 ;	  supported by the display adapter
    96 00007F05                                 ;SeeAlso: AX=4E00h,AX=4F01h,AX=7F00h"SOLLEX",AX=A00Ch
    97 00007F05                                 ;Index:	installation check;VESA SuperVGA
    98 00007F05                                 
    99 00007F05                                 
   100 00007F05                                 ;#00077
   101 00007F05                                 ;Format of SuperVGA information:
   102 00007F05                                 ;Offset	Size	Description	)
   103 00007F05                                 ; 00h  4 BYTEs	(ret) signature ("VESA")
   104 00007F05                                 ;		(call) VESA 2.0 request signature ("VBE2"), required to receive
   105 00007F05                                 ;		  version 2.0 info
   106 00007F05                                 ; 04h	WORD	VESA version number (one-digit minor version -- 0102h = v1.2)
   107 00007F05                                 ; 06h	DWORD	pointer to OEM name
   108 00007F05                                 ;		"761295520" for ATI
   109 00007F05                                 ; 0Ah	DWORD	capabilities flags (see #00078)
   110 00007F05                                 ; 0Eh	DWORD	pointer to list of supported VESA and OEM video modes
   111 00007F05                                 ;		(list of words terminated with FFFFh)
   112 00007F05                                 ; 12h	WORD	total amount of video memory in 64K blocks
   113 00007F05                                 ;---VBE v1.x ---
   114 00007F05                                 ; 14h 236 BYTEs	reserved
   115 00007F05                                 ;---VBE v2.0 ---
   116 00007F05                                 ; 14h	WORD	OEM software version (BCD, high byte = major, low byte = minor)
   117 00007F05                                 ; 16h	DWORD	pointer to vendor name
   118 00007F05                                 ; 1Ah	DWORD	pointer to product name
   119 00007F05                                 ; 1Eh	DWORD	pointer to product revision string
   120 00007F05                                 ; 22h	WORD	(if capabilities bit 3 set) VBE/AF version (BCD)
   121 00007F05                                 ;		0100h for v1.0P
   122 00007F05                                 ; 24h	DWORD	(if capabilities bit 3 set) pointer to list of supported
   123 00007F05                                 ;		  accelerated video modes (list of words terminated with FFFFh)
   124 00007F05                                 ; 28h 216 BYTEs	reserved for VBE implementation
   125 00007F05                                 ;100h 256 BYTEs	OEM scratchpad (for OEM strings, etc.)
   126 00007F05                                 ;Notes:	the list of supported video modes is stored in the reserved portion of
   127 00007F05                                 ;	  the SuperVGA information record by some implementations, and it may
   128 00007F05                                 ;	  thus be necessary to either copy the mode list or use a different
   129 00007F05                                 ;	  buffer for all subsequent VESA calls
   130 00007F05                                 ;	not all of the video modes in the list of mode numbers may be
   131 00007F05                                 ;	  supported, e.g. if they require more memory than currently installed
   132 00007F05                                 ;	  or are not supported by the attached monitor.	 Check any mode you
   133 00007F05                                 ;	  intend to use through AX=4F01h first.
   134 00007F05                                 ;	the 1.1 VESA document specifies 242 reserved bytes at the end, so the
   135 00007F05                                 ;	  buffer should be 262 bytes to ensure that it is not overrun; for
   136 00007F05                                 ;	  v2.0, the buffer should be 512 bytes
   137 00007F05                                 ;	the S3 specific video modes will most likely follow the FFFFh
   138 00007F05                                 ;	  terminator at the end of the standard modes.	A search must then
   139 00007F05                                 ;	  be made to find them, FFFFh will also terminate this second list
   140 00007F05                                 ;	in some cases, only a "stub" VBE may be present, supporting only
   141 00007F05                                 ;	  AX=4F00h; this case may be assumed if the list of supported video
   142 00007F05                                 ;	  modes is empty (consisting of a single word of FFFFh)
   143 00007F05                                 
   144 00007F05                                 
   145 00007F05 B8 9000                         		MOV		AX,9000H
   146 00007F08 8E C0                           		MOV		ES,AX
   147 00007F0A BF 0000                         		MOV		DI,0000H
   148 00007F0D                                 ;Check VESA
   149 00007F0D B8 4F00                         		MOV		AX,4F00H
   150 00007F10 CD 10                           		INT		10H
   151 00007F12 3D 004F                         		CMP		AX,004FH
   152 00007F15                                 ;		JNE		scrn320
   153 00007F15 75 55                           		JNE		scrn640 ; <>
   154 00007F17                                 
   155 00007F17                                 ;successful
   156 00007F17                                 
   157 00007F17 26 8B 45 04                     		MOV		AX,[ES:DI+04H] ; VESA version number
   158 00007F1B 3D 0200                         		CMP		AX,0200H
   159 00007F1E                                 ;		JB		scrn320
   160 00007F1E 72 4C                           		JB		scrn640 ; < 2.00
   161 00007F20                                 
   162 00007F20                                 ;INT 10 - VESA SuperVGA BIOS - GET SuperVGA MODE INFORMATION
   163 00007F20                                 ;
   164 00007F20                                 ;	AX = 4F01h
   165 00007F20                                 ;	CX = SuperVGA video mode (see #04082 for bitfields)
   166 00007F20                                 ;	ES:DI -> 256-byte buffer for mode information (see #00079)
   167 00007F20                                 ;Return: AL = 4Fh if function supported
   168 00007F20                                 ;	AH = status
   169 00007F20                                 ;	    00h successful
   170 00007F20                                 ;		ES:DI buffer filled
   171 00007F20                                 ;	    01h failed
   172 00007F20                                 ;Desc:	determine the attributes of the specified video mode
   173 00007F20                                 
   174 00007F20                                 ;#04082
   175 00007F20                                 ;Bitfields for VESA/VBE video mode number:
   176 00007F20                                 ;Bit(s)	Description	)
   177 00007F20                                 ; 15	preserve display memory on mode change
   178 00007F20                                 ; 14	(VBE v2.0+) use linear (flat) frame buffer
   179 00007F20                                 ; 13	(VBE/AF 1.0P) VBE/AF initializes accelerator hardware
   180 00007F20                                 ; 12	reserved for VBE/AF
   181 00007F20                                 ; 11	(VBE v3.0) user user-specified CRTC refresh rate values
   182 00007F20                                 ; 10-9	reserved for future expansion
   183 00007F20                                 ; 8-0	video mode number (0xxh are non-VESA modes, 1xxh are VESA-defined)
   184 00007F20                                 
   185 00007F20                                 ;#00079
   186 00007F20                                 ;Format of VESA SuperVGA mode information:
   187 00007F20                                 ;Offset	Size	Description	)
   188 00007F20                                 ; 00h	WORD	mode attributes (see #00080)
   189 00007F20                                 ; 02h	BYTE	window attributes, window A (see #00081)
   190 00007F20                                 ; 03h	BYTE	window attributes, window B (see #00081)
   191 00007F20                                 ; 04h	WORD	window granularity in KB
   192 00007F20                                 ; 06h	WORD	window size in KB
   193 00007F20                                 ; 08h	WORD	start segment of window A (0000h if not supported)
   194 00007F20                                 ; 0Ah	WORD	start segment of window B (0000h if not supported)
   195 00007F20                                 ; 0Ch	DWORD	-> FAR window positioning function (equivalent to AX=4F05h)
   196 00007F20                                 ; 10h	WORD	bytes per scan line
   197 00007F20                                 ;---remainder is optional for VESA modes in v1.0/1.1, needed for OEM modes---
   198 00007F20                                 ; 12h	WORD	width in pixels (graphics) or characters (text)
   199 00007F20                                 ; 14h	WORD	height in pixels (graphics) or characters (text)
   200 00007F20                                 ; 16h	BYTE	width of character cell in pixels
   201 00007F20                                 ; 17h	BYTE	height of character cell in pixels
   202 00007F20                                 ; 18h	BYTE	number of memory planes
   203 00007F20                                 ; 19h	BYTE	number of bits per pixel
   204 00007F20                                 ; 1Ah	BYTE	number of banks
   205 00007F20                                 ; 1Bh	BYTE	memory model type (see #00082)
   206 00007F20                                 ; 1Ch	BYTE	size of bank in KB
   207 00007F20                                 ; 1Dh	BYTE	number of image pages (less one) that will fit in video RAM
   208 00007F20                                 ; 1Eh	BYTE	reserved (00h for VBE 1.0-2.0, 01h for VBE 3.0)
   209 00007F20                                 ;---VBE v1.2+ ---
   210 00007F20                                 ; 1Fh	BYTE	red mask size
   211 00007F20                                 ; 20h	BYTE	red field position
   212 00007F20                                 ; 21h	BYTE	green mask size
   213 00007F20                                 ; 22h	BYTE	green field size
   214 00007F20                                 ; 23h	BYTE	blue mask size
   215 00007F20                                 ; 24h	BYTE	blue field size
   216 00007F20                                 ; 25h	BYTE	reserved mask size
   217 00007F20                                 ; 26h	BYTE	reserved mask position
   218 00007F20                                 ; 27h	BYTE	direct color mode info
   219 00007F20                                 ;		bit 0: color ramp is programmable
   220 00007F20                                 ;		bit 1: bytes in reserved field may be used by application
   221 00007F20                                 ;---VBE v2.0+ ---
   222 00007F20                                 ; 28h	DWORD	physical address of linear video buffer
   223 00007F20                                 ; 2Ch	DWORD	pointer to start of offscreen memory
   224 00007F20                                 ; 30h	WORD	KB of offscreen memory
   225 00007F20                                 ;---VBE v3.0 ---
   226 00007F20                                 ; 32h	WORD	bytes per scan line in linear modes
   227 00007F20                                 ; 34h	BYTE	number of images (less one) for banked video modes
   228 00007F20                                 ; 35h	BYTE	number of images (less one) for linear video modes
   229 00007F20                                 ; 36h	BYTE	linear modes: size of direct color red mask (in bits)
   230 00007F20                                 ; 37h	BYTE	linear modes: bit position of red mask LSB (e.g. shift count)
   231 00007F20                                 ; 38h	BYTE	linear modes: size of direct color green mask (in bits)
   232 00007F20                                 ; 39h	BYTE	linear modes: bit position of green mask LSB (e.g. shift count)
   233 00007F20                                 ; 3Ah	BYTE	linear modes: size of direct color blue mask (in bits)
   234 00007F20                                 ; 3Bh	BYTE	linear modes: bit position of blue mask LSB (e.g. shift count)
   235 00007F20                                 ; 3Ch	BYTE	linear modes: size of direct color reserved mask (in bits)
   236 00007F20                                 ; 3Dh	BYTE	linear modes: bit position of reserved mask LSB
   237 00007F20                                 ; 3Eh	DWORD	maximum pixel clock for graphics video mode, in Hz
   238 00007F20                                 ; 42h 190 BYTEs	reserved (0)
   239 00007F20                                 ;Note:	while VBE 1.1 and higher will zero out all unused bytes of the buffer,
   240 00007F20                                 ;	  v1.0 did not, so applications that want to be backward compatible
   241 00007F20                                 ;	  should clear the buffer before calling
   242 00007F20                                 
   243 00007F20                                 
   244 00007F20 B9 0111                         		MOV		CX, VBEMODE
   245 00007F23 B8 4F01                         		MOV		AX, 4F01H                ; Get VESA mode information
   246 00007F26 CD 10                           		INT		10H
   247 00007F28 3D 004F                         		CMP		AX, 004FH
   248 00007F2B                                 ;		JNE		scrn320
   249 00007F2B 75 3F                           		JNE		scrn640 ; <>
   250 00007F2D                                 
   251 00007F2D                                 ; successful
   252 00007F2D                                 
   253 00007F2D                                 ;		CMP		BYTE [ES:DI+0x19], 08H   ;number of bits per pixel
   254 00007F2D 26 80 7D 19 10                  		CMP		BYTE [ES:DI+0x19], 10H
   255 00007F32                                 ;		JNE		scrn320
   256 00007F32 75 38                           		JNE		scrn640 ; <> 16 bit
   257 00007F34                                 
   258 00007F34                                 ;#00082
   259 00007F34                                 ;Values for VESA SuperVGA memory model type:
   260 00007F34                                 ; 00h	text
   261 00007F34                                 ; 01h	CGA graphics
   262 00007F34                                 ; 02h	HGC graphics
   263 00007F34                                 ; 03h	16-color (EGA) graphics
   264 00007F34                                 ; 04h	packed pixel graphics
   265 00007F34                                 ; 05h	"sequ 256" (non-chain 4) graphics
   266 00007F34                                 ; 06h	direct color (HiColor, 24-bit color)
   267 00007F34                                 ; 07h	YUV (luminance-chrominance, also called YIQ)
   268 00007F34                                 ; 08h-0Fh reserved for VESA
   269 00007F34                                 ; 10h-FFh OEM memory models
   270 00007F34                                 
   271 00007F34                                 ;		CMP		BYTE [ES:DI+0x1b],04H   ; memory model type (see #00082)
   272 00007F34 26 80 7D 1B 06                  		CMP		BYTE [ES:DI+0x1b],06H
   273 00007F39                                 ;		JNE		scrn320
   274 00007F39 75 31                           		JNE		scrn640 ; <> 06h
   275 00007F3B                                 
   276 00007F3B                                 ;#00080
   277 00007F3B                                 ;Bitfields for VESA SuperVGA mode attributes:
   278 00007F3B                                 ;Bit(s)	Description	)
   279 00007F3B                                 ; 0	mode supported by present hardware configuration
   280 00007F3B                                 ; 1	optional information available (must be =1 for VBE v1.2+)
   281 00007F3B                                 ; 2	BIOS output supported
   282 00007F3B                                 ; 3	set if color, clear if monochrome
   283 00007F3B                                 ; 4	set if graphics mode, clear if text mode
   284 00007F3B                                 ;---VBE v2.0+ ---
   285 00007F3B                                 ; 5	mode is not VGA-compatible
   286 00007F3B                                 ; 6	bank-switched mode not supported
   287 00007F3B                                 ; 7	linear framebuffer mode supported
   288 00007F3B                                 ; 8	double-scan mode available (e.g. 320x200 and 320x240)
   289 00007F3B                                 ;---VBE v3.0 ---
   290 00007F3B                                 ; 9	interlaced mode available
   291 00007F3B                                 ; 10	hardware supports triple buffering
   292 00007F3B                                 ; 11	hardware supports stereoscopic display
   293 00007F3B                                 ; 12	dual display start address support
   294 00007F3B                                 ; 13-15	reserved
   295 00007F3B                                 ;---VBE/AF v1.0P---
   296 00007F3B                                 ; 9	application must call EnableDirectAccess before calling bank-switching
   297 00007F3B                                 ;	  functions
   298 00007F3B                                 
   299 00007F3B 26 8B 05                        		MOV		AX,[ES:DI+00H]          ; mode attributes (see #00080)
   300 00007F3E 25 0080                         		AND		AX,0080H                ; linear framebuffer mode supported
   301 00007F41                                 ;		JZ		scrn320
   302 00007F41 74 29                           		JZ		scrn640
   303 00007F43                                 
   304 00007F43                                 ;		MOV		BYTE [VMODE],8
   305 00007F43 C6 06 05F2 10                   		MOV		BYTE [VMODE],16
   306 00007F48                                 ;		MOV		BYTE [VMODE],24
   307 00007F48 26 8B 45 12                     		MOV		AX, [ES:DI+0x12]  ; width in pixels (graphics) or characters (text)
   308 00007F4C A3 05F4                         		MOV		[SCRNX], AX
   309 00007F4F 26 8B 45 14                     		MOV		AX,[ES:DI+0x14]  ; height in pixels (graphics) or characters (text)
   310 00007F53 A3 05F6                         		MOV		[SCRNY],AX
   311 00007F56 66 26 8B 45 28                  		MOV		EAX, [ES:DI+0x28] ; physical address of linear video buffer
   312 00007F5B 66 A3 05F8                      		MOV		[VRAM], EAX
   313 00007F5F                                 ;		MOV		DWORD [VRAM], 000A0000H
   314 00007F5F                                 
   315 00007F5F                                 
   316 00007F5F                                 ;INT 10 - VESA SuperVGA BIOS - SET SuperVGA VIDEO MODE
   317 00007F5F                                 ;
   318 00007F5F                                 ;	AX = 4F02h
   319 00007F5F                                 ;	BX = new video mode (see #04082,#00083,#00084)
   320 00007F5F                                 ;	ES:DI -> (VBE 3.0+) CRTC information block, bit mode bit 11 set
   321 00007F5F                                 ;		  (see #04083)
   322 00007F5F                                 ;Return: AL = 4Fh if function supported
   323 00007F5F                                 ;	AH = status
   324 00007F5F                                 ;	    00h successful
   325 00007F5F                                 ;	    01h failed
   326 00007F5F                                 ;Notes:	bit 13 may only be set if the video mode is present in the list of
   327 00007F5F                                 ;	  accelerated video modes returned by AX=4F00h
   328 00007F5F                                 ;	if the DAC supports both 8 bits per primary color and 6 bits, it will
   329 00007F5F                                 ;	  be reset to 6 bits after a mode set; use AX=4F08h to restore 8 bits
   330 00007F5F                                 ;SeeAlso: AX=4E03h,AX=4F00h,AX=4F01h,AX=4F03h,AX=4F08h
   331 00007F5F                                 
   332 00007F5F                                 ;#00084
   333 00007F5F                                 ;Values for S3 OEM video mode:
   334 00007F5F                                 ; 201h	640x480x256
   335 00007F5F                                 ; 202h	800x600x16
   336 00007F5F                                 ; 203h	800x600x256
   337 00007F5F                                 ; 204h	1024x768x16
   338 00007F5F                                 ; 205h	1024x768x256
   339 00007F5F                                 ; 206h	1280x960x16
   340 00007F5F                                 ; 207h	1152x864x256 (Diamond Stealth 64)
   341 00007F5F                                 ; 208h	1280x1024x16
   342 00007F5F                                 ; 209h	1152x864x32K
   343 00007F5F                                 ; 20Ah	1152x864x64K (Diamond Stealth 64)
   344 00007F5F                                 ; 20Bh	1152x864x4G
   345 00007F5F                                 ; 211h	640x480x64K (Diamond Stealth 24)
   346 00007F5F                                 ; 211h	640x400x4G  (Diamond Stealth64 Video / Stealth64 Graphics)
   347 00007F5F                                 ; 212h	640x480x16M (Diamond Stealth 24)
   348 00007F5F                                 ; 301h	640x480x32K
   349 00007F5F                                 ;Note:	these modes are only available on video cards using S3's VESA driver
   350 00007F5F                                 ;SeeAlso: #00083,#00191,#00732 at INT 1A/AX=B102h
   351 00007F5F                                 ;Index:	video modes;S3
   352 00007F5F                                 
   353 00007F5F BB 4111                         		MOV		BX, VBEMODE + 4000H
   354 00007F62 B8 4F02                         		MOV		AX,4F02H          ; Set VBE mode
   355 00007F65 CD 10                           		INT		10H
   356 00007F67 3D 004F                         		CMP		AX, 004FH
   357 00007F6A                                 ;		JE		fin
   358 00007F6A                                 ;		JE		scrn640           ; ★
   359 00007F6A                                 
   360 00007F6A                                 ;#04083
   361 00007F6A                                 ;Format of VESA VBE CRTC Information Block:
   362 00007F6A                                 ;Offset	Size	Description	)
   363 00007F6A                                 ; 00h	WORD	total number of pixels horizontally
   364 00007F6A                                 ; 02h	WORD	horizontal sync start (in pixels)
   365 00007F6A                                 ; 04h	WORD	horizontal sync end (in pixels)
   366 00007F6A                                 ; 06h	WORD	total number of scan lines
   367 00007F6A                                 ; 08h	WORD	vertical sync start (in scan lines)
   368 00007F6A                                 ; 0Ah	WORD	vertical sync end (in scan lines)
   369 00007F6A                                 ; 0Ch	BYTE	flags (see #04084)
   370 00007F6A                                 ; 0Dh	DWORD	pixel clock, in Hz
   371 00007F6A                                 ; 11h	WORD	refresh rate, in 0.01 Hz units
   372 00007F6A                                 ;		this field MUST be set to pixel_clock / (HTotal * VTotal),
   373 00007F6A                                 ;		  even though it may not actually be used by the VBE
   374 00007F6A                                 ;		  implementation
   375 00007F6A                                 ; 13h 40 BYTEs	reserved
   376 00007F6A                                 
   377 00007F6A                                 
   378 00007F6A EB 20                           		JMP		keystatus
   379 00007F6C                                 ;		jmp		fin
   380 00007F6C                                 
   381 00007F6C                                 ;scrn320:
   382 00007F6C                                 ;		MOV		AL,0x13	
   383 00007F6C                                 ;		MOV		AH,0x00
   384 00007F6C                                 ;		INT		0x10
   385 00007F6C                                 ;		MOV		BYTE [VMODE],8
   386 00007F6C                                 ;		MOV		WORD [SCRNX],320
   387 00007F6C                                 ;		MOV		WORD [SCRNY],240
   388 00007F6C                                 ;		MOV		DWORD [VRAM],000A0000H
   389 00007F6C                                 ;		JMP		keystatus
   390 00007F6C                                 ;
   391 00007F6C                                 scrn640:
   392 00007F6C                                 ; 画面モードを設定
   393 00007F6C                                 
   394 00007F6C B4 00                           		MOV		AH, 00H
   395 00007F6E B0 13                           		MOV		AL, 13H			; VGAグラフィックス、13H：640×480 256色
   396 00007F70 CD 10                           		INT		10H
   397 00007F72                                 ;		MOV		BYTE [VMODE],16
   398 00007F72 C6 06 05F2 08                   		MOV		BYTE [VMODE],8
   399 00007F77 C7 06 05F4 0280                 		MOV		WORD [SCRNX],640
   400 00007F7D C7 06 05F6 01E0                 		MOV		WORD [SCRNY],480
   401 00007F83 66 C7 06 05F8 000A0000          		MOV		DWORD [VRAM],000A0000H
   402 00007F8C                                 ;		JMP		keystatus
   403 00007F8C                                 keystatus:
   404 00007F8C                                 
   405 00007F8C                                 
   406 00007F8C B4 02                           		MOV		AH,02H
   407 00007F8E CD 16                           		INT		16H			; keyboard BIOS
   408 00007F90                                 ;H->L:Ins、Caps Lock、Num Lock、Scroll Lock、Alt、Ctrl、Left Shift、Right Shift
   409 00007F90 A2 05F1                         		MOV		[LEDS],AL  ; 05f1
   410 00007F93                                 
   411 00007F93                                 ; PICが一切の割り込みを受け付けないようにする
   412 00007F93                                 ;	AT互換機の仕様では、PICの初期化をするなら、
   413 00007F93                                 ;	こいつをCLI前にやっておかないと、たまにハングアップする
   414 00007F93                                 ;	PICの初期化はあとでやる
   415 00007F93                                 
   416 00007F93 B0 FF                           		MOV		AL,0xff
   417 00007F95 E6 21                           		OUT		0x21,AL
   418 00007F97 90                              		NOP						; OUT命令を連続させるとうまくいかない機種があるらしいので
   419 00007F98 E6 A1                           		OUT		0xa1,AL
   420 00007F9A                                 
   421 00007F9A FA                              		CLI						; さらにCPUレベルでも割り込み禁止
   422 00007F9B                                 
   423 00007F9B                                 ; CPUから1MB以上のメモリにアクセスできるように、A20GATEを設定
   424 00007F9B                                 
   425 00007F9B E4 92                                          IN  AL , 92H
   426 00007F9D 0C 02                                          OR  AL , 02H     ; enable A20
   427 00007F9F E6 92                                          OUT 92H, AL
   428 00007FA1                                 
   429 00007FA1                                 
   430 00007FA1                                 
   431 00007FA1                                 ; プロテクトモード移行
   432 00007FA1                                 
   433 00007FA1                                 
   434 00007FA1 0F 01 16 807A                   		LGDT	[GDTR0]			; 暫定GDTを設定
   435 00007FA6 0F 20 C0                        		MOV		EAX,CR0
   436 00007FA9 66 25 7FFFFFFF                  		AND		EAX,0x7fffffff	; bit31を0にする（ページング禁止のため）
   437 00007FAF 66 83 C8 01                     		OR		EAX,0x00000001	; bit0を1にする（プロテクトモード移行のため）
   438 00007FB3 0F 22 C0                        		MOV		CR0,EAX
   439 00007FB6 EB 00                           		JMP		pipelineflush
   440 00007FB8                                 pipelineflush:
   441 00007FB8 B8 0008                         		MOV		AX,1*8			;  読み書き可能セグメント32bit
   442 00007FBB 8E D8                           		MOV		DS,AX
   443 00007FBD 8E C0                           		MOV		ES,AX
   444 00007FBF 8E E0                           		MOV		FS,AX
   445 00007FC1 8E E8                           		MOV		GS,AX
   446 00007FC3 8E D0                           		MOV		SS,AX
   447 00007FC5                                 
   448 00007FC5                                 ; bootpackの転送
   449 00007FC5                                 
   450 00007FC5 66 BE 00008080                  		MOV		ESI,bootpack	; 転送元
   451 00007FCB 66 BF 00280000                  		MOV		EDI,BOTPAK	; 転送先 0x00280000
   452 00007FD1 66 B9 00020000                  		MOV		ECX,512*1024/4
   453 00007FD7 E8 006E                         		CALL	memcpy
   454 00007FDA                                 
   455 00007FDA                                 ; ついでにディスクデータも本来の位置へ転送
   456 00007FDA                                 
   457 00007FDA                                 ; まずはブートセクタから
   458 00007FDA                                 
   459 00007FDA 66 BE 00000700                  		MOV		ESI,0700H	; 転送元
   460 00007FE0 66 BF 00100000                  		MOV		EDI,DSKCAC	; 転送先 0x00100000
   461 00007FE6 66 B9 00000080                  		MOV		ECX,512/4
   462 00007FEC E8 0059                         		CALL	memcpy
   463 00007FEF                                 
   464 00007FEF                                 ; 残り全部
   465 00007FEF                                 
   466 00007FEF 66 BE 00000B00                  		MOV		ESI,DSKCAC0+512	; 転送元 0x00008000 0x00000900
   467 00007FF5 66 BF 00100200                  		MOV		EDI,DSKCAC +512	; 転送先 0x00100000
   468 00007FFB 66 B9 00000000                  		MOV		ECX,0
   469 00008001 8A 0E 05F0                      		MOV		CL,BYTE [CYLS]
   470 00008005 66 69 C9 00001200               		IMUL	ECX,512*18*2/4	; シリンダ数からバイト数/4に変換
   471 0000800C 66 81 E9 00000080               		SUB		ECX,512/4		; IPLの分だけ差し引く
   472 00008013 E8 0032                         		CALL	memcpy
   473 00008016                                 
   474 00008016                                 ; asmheadでしなければいけないことは全部し終わったので、
   475 00008016                                 ;	あとはbootpackに任せる
   476 00008016                                 
   477 00008016                                 ; bootpackの起動
   478 00008016                                 
   479 00008016 66 BB 00280000                  		MOV		EBX,BOTPAK              ; 0x00280000
   480 0000801C 67 66 8B 4B 10                  		MOV		ECX,[EBX+16]
   481 00008021 66 83 C1 03                     		ADD		ECX,3			; ECX += 3;
   482 00008025 66 C1 E9 02                     		SHR		ECX,2			; ECX /= 4;
   483 00008029 74 10                           		JZ		skip			; 転送するべきものがない
   484 0000802B 67 66 8B 73 14                  		MOV		ESI,[EBX+20]	; 転送元
   485 00008030 66 01 DE                        		ADD		ESI,EBX
   486 00008033 67 66 8B 7B 0C                  		MOV		EDI,[EBX+12]	; 転送先
   487 00008038 E8 000D                         		CALL	memcpy
   488 0000803B                                 skip:
   489 0000803B 67 66 8B 63 0C                  		MOV		ESP,[EBX+12]	; スタック初期値
   490 00008040 66 EA 0000001B 0010             		JMP		DWORD 2*8:0x0000001b
   491 00008048                                 
   492 00008048                                 ; waitkbdout:
   493 00008048                                 ; 		IN		 AL,64H
   494 00008048                                 ; 		AND		 AL,02H
   495 00008048                                 ; 		JNZ		waitkbdout		; ANDの結果が0でなければwaitkbdoutへ
   496 00008048                                 ; 		RET
   497 00008048                                 
   498 00008048                                 
   499 00008048                                 memcpy:
   500 00008048 67 66 8B 06                     		MOV		EAX,[ESI]
   501 0000804C 66 83 C6 04                     		ADD		ESI,4
   502 00008050 67 66 89 07                     		MOV		[EDI],EAX
   503 00008054 66 83 C7 04                     		ADD		EDI,4
   504 00008058 66 83 E9 01                     		SUB		ECX,1
   505 0000805C 75 EA                           		JNZ		memcpy			; 引き算した結果が0でなければmemcpyへ
   506 0000805E C3                              		RET
   507 0000805F                                 ; memcpyはアドレスサイズプリフィクスを入れ忘れなければ、ストリング命令でも書ける
   508 0000805F                                 
   509 0000805F                                 
   510 0000805F                                 ;fin:
   511 0000805F                                 ;		HLT
   512 0000805F                                 ;		JMP		fin
   513 0000805F                                 
   514 0000805F                                 
   515 0000805F 00                              		ALIGNB	16
   516 00008060                                 GDT0:
   517 00008060 00000000 00000000               		DD 00000000H, 00000000H
   518 00008068 0000FFFF 00CF9200               		DD 0000FFFFH, 00CF9200H
   519 00008070 0000FFFF 00479A28               		DD 0000FFFFH, 00479A28H
   520 00008078                                 
   521 00008078                                 
   522 00008078                                 
   523 00008078 0000                            		DW		0
   524 0000807A                                 GDTR0:
   525 0000807A 0017                            		DW		8*3-1 ; limit 8 * n - 1
   526 0000807C 00008060                        		DD		GDT0  ; base
   527 00008080                                 
   528 00008080                                 		ALIGNB	16
   529 00008080                                 bootpack:
