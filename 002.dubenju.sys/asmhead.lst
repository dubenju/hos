     1 00000000                                 ; haribote-os boot asm
     2 00000000                                 ; TAB=4
     3 00000000                                 
     4 00000000                                 [INSTRSET "i486p"]				; 486の命令まで使いたいという記述
     5 00000000                                 
     6 00000000                                 ;VBEMODE EQU 0x101 ;  640 x  480 x 8bit Color
     7  = 00000114                              VBEMODE EQU 0x114
     8 00000000                                 ;VBEMODE EQU 0x111 ; 640 x  480 x 16bit Color
     9 00000000                                 ;  0x100 :  640 x  400 x 8bit Color
    10 00000000                                 ;  0x101 :  640 x  480 x 8bit Color
    11 00000000                                 ;  0x103 :  800 x  600 x 8bit Color
    12 00000000                                 ;  0x105 : 1024 x  768 x 8bit Color
    13 00000000                                 ;  0x107 : 1280 x 1024 x 8bit Color
    14 00000000                                 
    15 00000000                                 ;  0x111 :  640 x  480 x 16bit Color
    16 00000000                                 ;  0x114 :  800 x  600 x 16bit Color
    17 00000000                                 ;  0x117 : 1024 x  768 x 16bit Color
    18 00000000                                 ;  0x11A : 1280 x 1024 x 16bit Color
    19 00000000                                 
    20 00000000                                 ;#00083
    21 00000000                                 ;Values for VESA video mode:
    22 00000000                                 ; 00h-FFh OEM video modes (see #00010 at AH=00h)
    23 00000000                                 ; 100h	640x400x256
    24 00000000                                 ; 101h	640x480x256
    25 00000000                                 ; 102h	800x600x16
    26 00000000                                 ; 103h	800x600x256
    27 00000000                                 ; 104h	1024x768x16
    28 00000000                                 ; 105h	1024x768x256
    29 00000000                                 ; 106h	1280x1024x16
    30 00000000                                 ; 107h	1280x1024x256
    31 00000000                                 ; 108h	80x60 text
    32 00000000                                 ; 109h	132x25 text
    33 00000000                                 ; 10Ah	132x43 text
    34 00000000                                 ; 10Bh	132x50 text
    35 00000000                                 ; 10Ch	132x60 text
    36 00000000                                 ;---VBE v1.2+ ---
    37 00000000                                 ; 10Dh	320x200x32K
    38 00000000                                 ; 10Eh	320x200x64K
    39 00000000                                 ; 10Fh	320x200x16M
    40 00000000                                 ; 110h	640x480x32K
    41 00000000                                 ; 111h	640x480x64K
    42 00000000                                 ; 112h	640x480x16M
    43 00000000                                 ; 113h	800x600x32K
    44 00000000                                 ; 114h	800x600x64K
    45 00000000                                 ; 115h	800x600x16M
    46 00000000                                 ; 116h	1024x768x32K
    47 00000000                                 ; 117h	1024x768x64K
    48 00000000                                 ; 118h	1024x768x16M
    49 00000000                                 ; 119h	1280x1024x32K (1:5:5:5)
    50 00000000                                 ; 11Ah	1280x1024x64K (5:6:5)
    51 00000000                                 ; 11Bh	1280x1024x16M
    52 00000000                                 ;---VBE 2.0+ ---
    53 00000000                                 ; 120h	1600x1200x256
    54 00000000                                 ; 121h	1600x1200x32K
    55 00000000                                 ; 122h	1600x1200x64K
    56 00000000                                 ;81FFh	special full-memory access mode
    57 00000000                                 ;Notes:	the special mode 81FFh preserves the contents of the video memory and
    58 00000000                                 ;	  gives access to all of the memory; VESA recommends that the special
    59 00000000                                 ;	  mode be a packed-pixel mode.	For VBE 2.0+, it is required that the
    60 00000000                                 ;	  VBE implement the mode, but not place it in the list of available
    61 00000000                                 ;	  modes (mode information for this mode can be queried directly,
    62 00000000                                 ;	  however).
    63 00000000                                 ;	as of VBE 2.0, VESA will no longer define video mode numbers
    64 00000000                                 
    65 00000000                                 
    66  = 00280000                              BOTPAK	EQU		0x00280000		; bootpackのロード先
    67  = 00100000                              DSKCAC	EQU		0x00100000		; ディスクキャッシュの場所
    68  = 00000900                              DSKCAC0	EQU		0x00000900		; ディスクキャッシュの場所（リアルモード）
    69 00000000                                 
    70 00000000                                 ; BOOT_INFO関係
    71  = 000005F0                              CYLS	EQU		0x05f0			; ブートセクタが設定する
    72  = 000005F1                              LEDS	EQU		0x05f1
    73  = 000005F2                              VMODE	EQU		0x05f2			; 色数に関する情報。何ビットカラーか？
    74  = 000005F4                              SCRNX	EQU		0x05f4			; 解像度のX
    75  = 000005F6                              SCRNY	EQU		0x05f6			; 解像度のY
    76  = 000005F8                              VRAM	EQU		0x05f8			; グラフィックバッファの開始番地
    77 00000000                                 
    78                                          		ORG		0x0700			; このプログラムがどこに読み込まれるのか
    79 00000700 C6 06 05F0 01                   		MOV		BYTE  [CYLS],1 
    80 00000705                                 
    81 00000705                                 ;INT 10 - VESA SuperVGA BIOS (VBE) - GET SuperVGA INFORMATION
    82 00000705                                 ;	AX = 4F00h
    83 00000705                                 ;	ES:DI -> buffer for SuperVGA information (see #00077)
    84 00000705                                 ;Return: AL = 4Fh if function supported
    85 00000705                                 ;	AH = status
    86 00000705                                 ;	    00h successful
    87 00000705                                 ;		ES:DI buffer filled
    88 00000705                                 ;	    01h failed
    89 00000705                                 ;	    ---VBE v2.0---
    90 00000705                                 ;	    02h function not supported by current hardware configuration
    91 00000705                                 ;	    03h function invalid in current video mode
    92 00000705                                 ;Desc:	determine whether VESA BIOS extensions are present and the capabilities
    93 00000705                                 ;	  supported by the display adapter
    94 00000705                                 ;SeeAlso: AX=4E00h,AX=4F01h,AX=7F00h"SOLLEX",AX=A00Ch
    95 00000705                                 ;Index:	installation check;VESA SuperVGA
    96 00000705                                 
    97 00000705                                 
    98 00000705                                 ;#00077
    99 00000705                                 ;Format of SuperVGA information:
   100 00000705                                 ;Offset	Size	Description	)
   101 00000705                                 ; 00h  4 BYTEs	(ret) signature ("VESA")
   102 00000705                                 ;		(call) VESA 2.0 request signature ("VBE2"), required to receive
   103 00000705                                 ;		  version 2.0 info
   104 00000705                                 ; 04h	WORD	VESA version number (one-digit minor version -- 0102h = v1.2)
   105 00000705                                 ; 06h	DWORD	pointer to OEM name
   106 00000705                                 ;		"761295520" for ATI
   107 00000705                                 ; 0Ah	DWORD	capabilities flags (see #00078)
   108 00000705                                 ; 0Eh	DWORD	pointer to list of supported VESA and OEM video modes
   109 00000705                                 ;		(list of words terminated with FFFFh)
   110 00000705                                 ; 12h	WORD	total amount of video memory in 64K blocks
   111 00000705                                 ;---VBE v1.x ---
   112 00000705                                 ; 14h 236 BYTEs	reserved
   113 00000705                                 ;---VBE v2.0 ---
   114 00000705                                 ; 14h	WORD	OEM software version (BCD, high byte = major, low byte = minor)
   115 00000705                                 ; 16h	DWORD	pointer to vendor name
   116 00000705                                 ; 1Ah	DWORD	pointer to product name
   117 00000705                                 ; 1Eh	DWORD	pointer to product revision string
   118 00000705                                 ; 22h	WORD	(if capabilities bit 3 set) VBE/AF version (BCD)
   119 00000705                                 ;		0100h for v1.0P
   120 00000705                                 ; 24h	DWORD	(if capabilities bit 3 set) pointer to list of supported
   121 00000705                                 ;		  accelerated video modes (list of words terminated with FFFFh)
   122 00000705                                 ; 28h 216 BYTEs	reserved for VBE implementation
   123 00000705                                 ;100h 256 BYTEs	OEM scratchpad (for OEM strings, etc.)
   124 00000705                                 ;Notes:	the list of supported video modes is stored in the reserved portion of
   125 00000705                                 ;	  the SuperVGA information record by some implementations, and it may
   126 00000705                                 ;	  thus be necessary to either copy the mode list or use a different
   127 00000705                                 ;	  buffer for all subsequent VESA calls
   128 00000705                                 ;	not all of the video modes in the list of mode numbers may be
   129 00000705                                 ;	  supported, e.g. if they require more memory than currently installed
   130 00000705                                 ;	  or are not supported by the attached monitor.	 Check any mode you
   131 00000705                                 ;	  intend to use through AX=4F01h first.
   132 00000705                                 ;	the 1.1 VESA document specifies 242 reserved bytes at the end, so the
   133 00000705                                 ;	  buffer should be 262 bytes to ensure that it is not overrun; for
   134 00000705                                 ;	  v2.0, the buffer should be 512 bytes
   135 00000705                                 ;	the S3 specific video modes will most likely follow the FFFFh
   136 00000705                                 ;	  terminator at the end of the standard modes.	A search must then
   137 00000705                                 ;	  be made to find them, FFFFh will also terminate this second list
   138 00000705                                 ;	in some cases, only a "stub" VBE may be present, supporting only
   139 00000705                                 ;	  AX=4F00h; this case may be assumed if the list of supported video
   140 00000705                                 ;	  modes is empty (consisting of a single word of FFFFh)
   141 00000705                                 
   142 00000705                                 
   143 00000705 B8 9000                         		MOV		AX,9000H
   144 00000708 8E C0                           		MOV		ES,AX
   145 0000070A BF 0000                         		MOV		DI,0000H
   146 0000070D                                 ;Check VESA
   147 0000070D B8 4F00                         		MOV		AX,4F00H
   148 00000710 CD 10                           		INT		10H
   149 00000712 3D 004F                         		CMP		AX,004FH
   150 00000715                                 ;		JNE		scrn320
   151 00000715 75 5D                           		JNE		scrn640 ; <>
   152 00000717                                 
   153 00000717                                 ;successful
   154 00000717                                 
   155 00000717 26 8B 45 04                     		MOV		AX,[ES:DI+04H] ; VESA version number
   156 0000071B 3D 0200                         		CMP		AX,0200H
   157 0000071E                                 ;		JB		scrn320
   158 0000071E 72 54                           		JB		scrn640 ; < 2.00
   159 00000720                                 
   160 00000720                                 ;INT 10 - VESA SuperVGA BIOS - GET SuperVGA MODE INFORMATION
   161 00000720                                 ;
   162 00000720                                 ;	AX = 4F01h
   163 00000720                                 ;	CX = SuperVGA video mode (see #04082 for bitfields)
   164 00000720                                 ;	ES:DI -> 256-byte buffer for mode information (see #00079)
   165 00000720                                 ;Return: AL = 4Fh if function supported
   166 00000720                                 ;	AH = status
   167 00000720                                 ;	    00h successful
   168 00000720                                 ;		ES:DI buffer filled
   169 00000720                                 ;	    01h failed
   170 00000720                                 ;Desc:	determine the attributes of the specified video mode
   171 00000720                                 
   172 00000720                                 ;#04082
   173 00000720                                 ;Bitfields for VESA/VBE video mode number:
   174 00000720                                 ;Bit(s)	Description	)
   175 00000720                                 ; 15	preserve display memory on mode change
   176 00000720                                 ; 14	(VBE v2.0+) use linear (flat) frame buffer
   177 00000720                                 ; 13	(VBE/AF 1.0P) VBE/AF initializes accelerator hardware
   178 00000720                                 ; 12	reserved for VBE/AF
   179 00000720                                 ; 11	(VBE v3.0) user user-specified CRTC refresh rate values
   180 00000720                                 ; 10-9	reserved for future expansion
   181 00000720                                 ; 8-0	video mode number (0xxh are non-VESA modes, 1xxh are VESA-defined)
   182 00000720                                 
   183 00000720                                 ;#00079
   184 00000720                                 ;Format of VESA SuperVGA mode information:
   185 00000720                                 ;Offset	Size	Description	)
   186 00000720                                 ; 00h	WORD	mode attributes (see #00080)
   187 00000720                                 ; 02h	BYTE	window attributes, window A (see #00081)
   188 00000720                                 ; 03h	BYTE	window attributes, window B (see #00081)
   189 00000720                                 ; 04h	WORD	window granularity in KB
   190 00000720                                 ; 06h	WORD	window size in KB
   191 00000720                                 ; 08h	WORD	start segment of window A (0000h if not supported)
   192 00000720                                 ; 0Ah	WORD	start segment of window B (0000h if not supported)
   193 00000720                                 ; 0Ch	DWORD	-> FAR window positioning function (equivalent to AX=4F05h)
   194 00000720                                 ; 10h	WORD	bytes per scan line
   195 00000720                                 ;---remainder is optional for VESA modes in v1.0/1.1, needed for OEM modes---
   196 00000720                                 ; 12h	WORD	width in pixels (graphics) or characters (text)
   197 00000720                                 ; 14h	WORD	height in pixels (graphics) or characters (text)
   198 00000720                                 ; 16h	BYTE	width of character cell in pixels
   199 00000720                                 ; 17h	BYTE	height of character cell in pixels
   200 00000720                                 ; 18h	BYTE	number of memory planes
   201 00000720                                 ; 19h	BYTE	number of bits per pixel
   202 00000720                                 ; 1Ah	BYTE	number of banks
   203 00000720                                 ; 1Bh	BYTE	memory model type (see #00082)
   204 00000720                                 ; 1Ch	BYTE	size of bank in KB
   205 00000720                                 ; 1Dh	BYTE	number of image pages (less one) that will fit in video RAM
   206 00000720                                 ; 1Eh	BYTE	reserved (00h for VBE 1.0-2.0, 01h for VBE 3.0)
   207 00000720                                 ;---VBE v1.2+ ---
   208 00000720                                 ; 1Fh	BYTE	red mask size
   209 00000720                                 ; 20h	BYTE	red field position
   210 00000720                                 ; 21h	BYTE	green mask size
   211 00000720                                 ; 22h	BYTE	green field size
   212 00000720                                 ; 23h	BYTE	blue mask size
   213 00000720                                 ; 24h	BYTE	blue field size
   214 00000720                                 ; 25h	BYTE	reserved mask size
   215 00000720                                 ; 26h	BYTE	reserved mask position
   216 00000720                                 ; 27h	BYTE	direct color mode info
   217 00000720                                 ;		bit 0: color ramp is programmable
   218 00000720                                 ;		bit 1: bytes in reserved field may be used by application
   219 00000720                                 ;---VBE v2.0+ ---
   220 00000720                                 ; 28h	DWORD	physical address of linear video buffer
   221 00000720                                 ; 2Ch	DWORD	pointer to start of offscreen memory
   222 00000720                                 ; 30h	WORD	KB of offscreen memory
   223 00000720                                 ;---VBE v3.0 ---
   224 00000720                                 ; 32h	WORD	bytes per scan line in linear modes
   225 00000720                                 ; 34h	BYTE	number of images (less one) for banked video modes
   226 00000720                                 ; 35h	BYTE	number of images (less one) for linear video modes
   227 00000720                                 ; 36h	BYTE	linear modes: size of direct color red mask (in bits)
   228 00000720                                 ; 37h	BYTE	linear modes: bit position of red mask LSB (e.g. shift count)
   229 00000720                                 ; 38h	BYTE	linear modes: size of direct color green mask (in bits)
   230 00000720                                 ; 39h	BYTE	linear modes: bit position of green mask LSB (e.g. shift count)
   231 00000720                                 ; 3Ah	BYTE	linear modes: size of direct color blue mask (in bits)
   232 00000720                                 ; 3Bh	BYTE	linear modes: bit position of blue mask LSB (e.g. shift count)
   233 00000720                                 ; 3Ch	BYTE	linear modes: size of direct color reserved mask (in bits)
   234 00000720                                 ; 3Dh	BYTE	linear modes: bit position of reserved mask LSB
   235 00000720                                 ; 3Eh	DWORD	maximum pixel clock for graphics video mode, in Hz
   236 00000720                                 ; 42h 190 BYTEs	reserved (0)
   237 00000720                                 ;Note:	while VBE 1.1 and higher will zero out all unused bytes of the buffer,
   238 00000720                                 ;	  v1.0 did not, so applications that want to be backward compatible
   239 00000720                                 ;	  should clear the buffer before calling
   240 00000720                                 
   241 00000720                                 
   242 00000720 B9 0114                         		MOV		CX, VBEMODE
   243 00000723 B8 4F01                         		MOV		AX, 4F01H
   244 00000726 CD 10                           		INT		10H
   245 00000728 3D 004F                         		CMP		AX, 004FH
   246 0000072B                                 ;		JNE		scrn320
   247 0000072B 75 47                           		JNE		scrn640 ; <>
   248 0000072D                                 
   249 0000072D                                 ; successful
   250 0000072D                                 
   251 0000072D                                 ;		CMP		BYTE [ES:DI+0x19],8   ;number of bits per pixel
   252 0000072D 26 80 7D 19 10                  		CMP		BYTE [ES:DI+0x19],16
   253 00000732                                 ;		JNE		scrn320
   254 00000732 75 40                           		JNE		scrn640 ; <> 16 bit
   255 00000734                                 
   256 00000734                                 ;#00082
   257 00000734                                 ;Values for VESA SuperVGA memory model type:
   258 00000734                                 ; 00h	text
   259 00000734                                 ; 01h	CGA graphics
   260 00000734                                 ; 02h	HGC graphics
   261 00000734                                 ; 03h	16-color (EGA) graphics
   262 00000734                                 ; 04h	packed pixel graphics
   263 00000734                                 ; 05h	"sequ 256" (non-chain 4) graphics
   264 00000734                                 ; 06h	direct color (HiColor, 24-bit color)
   265 00000734                                 ; 07h	YUV (luminance-chrominance, also called YIQ)
   266 00000734                                 ; 08h-0Fh reserved for VESA
   267 00000734                                 ; 10h-FFh OEM memory models
   268 00000734                                 
   269 00000734                                 ;		CMP		BYTE [ES:DI+0x1b],04H   ; memory model type (see #00082)
   270 00000734 26 80 7D 1B 06                  		CMP		BYTE [ES:DI+0x1b],06H
   271 00000739                                 ;		JNE		scrn320
   272 00000739 75 39                           		JNE		scrn640 ; <> 06h
   273 0000073B                                 
   274 0000073B                                 ;#00080
   275 0000073B                                 ;Bitfields for VESA SuperVGA mode attributes:
   276 0000073B                                 ;Bit(s)	Description	)
   277 0000073B                                 ; 0	mode supported by present hardware configuration
   278 0000073B                                 ; 1	optional information available (must be =1 for VBE v1.2+)
   279 0000073B                                 ; 2	BIOS output supported
   280 0000073B                                 ; 3	set if color, clear if monochrome
   281 0000073B                                 ; 4	set if graphics mode, clear if text mode
   282 0000073B                                 ;---VBE v2.0+ ---
   283 0000073B                                 ; 5	mode is not VGA-compatible
   284 0000073B                                 ; 6	bank-switched mode not supported
   285 0000073B                                 ; 7	linear framebuffer mode supported
   286 0000073B                                 ; 8	double-scan mode available (e.g. 320x200 and 320x240)
   287 0000073B                                 ;---VBE v3.0 ---
   288 0000073B                                 ; 9	interlaced mode available
   289 0000073B                                 ; 10	hardware supports triple buffering
   290 0000073B                                 ; 11	hardware supports stereoscopic display
   291 0000073B                                 ; 12	dual display start address support
   292 0000073B                                 ; 13-15	reserved
   293 0000073B                                 ;---VBE/AF v1.0P---
   294 0000073B                                 ; 9	application must call EnableDirectAccess before calling bank-switching
   295 0000073B                                 ;	  functions
   296 0000073B                                 
   297 0000073B 26 8B 05                        		MOV		AX,[ES:DI+00H]          ; mode attributes (see #00080)
   298 0000073E 25 0080                         		AND		AX,0080H                ; linear framebuffer mode supported
   299 00000741                                 ;		JZ		scrn320
   300 00000741 74 31                           		JZ		scrn640
   301 00000743                                 
   302 00000743                                 ;		MOV		BYTE [VMODE],8
   303 00000743 C6 06 05F2 10                   		MOV		BYTE [VMODE],16
   304 00000748 26 8B 45 12                     		MOV		AX,[ES:DI+0x12]  ; width in pixels (graphics) or characters (text)
   305 0000074C                                 ;		MOV		[SCRNX],AX
   306 0000074C C7 06 05F4 0280                 		MOV		WORD [SCRNX],640
   307 00000752 26 8B 45 14                     		MOV		AX,[ES:DI+0x14]  ; height in pixels (graphics) or characters (text)
   308 00000756                                 ;		MOV		[SCRNY],AX
   309 00000756 C7 06 05F6 01E0                 		MOV		WORD [SCRNY],480
   310 0000075C 66 26 8B 45 28                  		MOV		EAX, [ES:DI+0x28] ; physical address of linear video buffer
   311 00000761                                 ;		MOV		[VRAM], EAX
   312 00000761 66 C7 06 05F8 000A0000          		MOV		DWORD [VRAM], 000A0000H
   313 0000076A                                 
   314 0000076A                                 
   315 0000076A                                 ;INT 10 - VESA SuperVGA BIOS - SET SuperVGA VIDEO MODE
   316 0000076A                                 ;
   317 0000076A                                 ;	AX = 4F02h
   318 0000076A                                 ;	BX = new video mode (see #04082,#00083,#00084)
   319 0000076A                                 ;	ES:DI -> (VBE 3.0+) CRTC information block, bit mode bit 11 set
   320 0000076A                                 ;		  (see #04083)
   321 0000076A                                 ;Return: AL = 4Fh if function supported
   322 0000076A                                 ;	AH = status
   323 0000076A                                 ;	    00h successful
   324 0000076A                                 ;	    01h failed
   325 0000076A                                 ;Notes:	bit 13 may only be set if the video mode is present in the list of
   326 0000076A                                 ;	  accelerated video modes returned by AX=4F00h
   327 0000076A                                 ;	if the DAC supports both 8 bits per primary color and 6 bits, it will
   328 0000076A                                 ;	  be reset to 6 bits after a mode set; use AX=4F08h to restore 8 bits
   329 0000076A                                 ;SeeAlso: AX=4E03h,AX=4F00h,AX=4F01h,AX=4F03h,AX=4F08h
   330 0000076A                                 
   331 0000076A                                 ;#00084
   332 0000076A                                 ;Values for S3 OEM video mode:
   333 0000076A                                 ; 201h	640x480x256
   334 0000076A                                 ; 202h	800x600x16
   335 0000076A                                 ; 203h	800x600x256
   336 0000076A                                 ; 204h	1024x768x16
   337 0000076A                                 ; 205h	1024x768x256
   338 0000076A                                 ; 206h	1280x960x16
   339 0000076A                                 ; 207h	1152x864x256 (Diamond Stealth 64)
   340 0000076A                                 ; 208h	1280x1024x16
   341 0000076A                                 ; 209h	1152x864x32K
   342 0000076A                                 ; 20Ah	1152x864x64K (Diamond Stealth 64)
   343 0000076A                                 ; 20Bh	1152x864x4G
   344 0000076A                                 ; 211h	640x480x64K (Diamond Stealth 24)
   345 0000076A                                 ; 211h	640x400x4G  (Diamond Stealth64 Video / Stealth64 Graphics)
   346 0000076A                                 ; 212h	640x480x16M (Diamond Stealth 24)
   347 0000076A                                 ; 301h	640x480x32K
   348 0000076A                                 ;Note:	these modes are only available on video cards using S3's VESA driver
   349 0000076A                                 ;SeeAlso: #00083,#00191,#00732 at INT 1A/AX=B102h
   350 0000076A                                 ;Index:	video modes;S3
   351 0000076A                                 
   352 0000076A BB 0114                         		MOV		BX, VBEMODE; + 4000H
   353 0000076D B8 4F02                         		MOV		AX,4F02H
   354 00000770 CD 10                           		INT		10H
   355 00000772                                 ;		CMP		AX, 004FH
   356 00000772                                 ;		JNE		fin
   357 00000772                                 
   358 00000772                                 ;#04083
   359 00000772                                 ;Format of VESA VBE CRTC Information Block:
   360 00000772                                 ;Offset	Size	Description	)
   361 00000772                                 ; 00h	WORD	total number of pixels horizontally
   362 00000772                                 ; 02h	WORD	horizontal sync start (in pixels)
   363 00000772                                 ; 04h	WORD	horizontal sync end (in pixels)
   364 00000772                                 ; 06h	WORD	total number of scan lines
   365 00000772                                 ; 08h	WORD	vertical sync start (in scan lines)
   366 00000772                                 ; 0Ah	WORD	vertical sync end (in scan lines)
   367 00000772                                 ; 0Ch	BYTE	flags (see #04084)
   368 00000772                                 ; 0Dh	DWORD	pixel clock, in Hz
   369 00000772                                 ; 11h	WORD	refresh rate, in 0.01 Hz units
   370 00000772                                 ;		this field MUST be set to pixel_clock / (HTotal * VTotal),
   371 00000772                                 ;		  even though it may not actually be used by the VBE
   372 00000772                                 ;		  implementation
   373 00000772                                 ; 13h 40 BYTEs	reserved
   374 00000772                                 
   375 00000772                                 
   376 00000772 EB 20                           		JMP		keystatus
   377 00000774                                 ;		jmp		fin
   378 00000774                                 
   379 00000774                                 ;scrn320:
   380 00000774                                 ;		MOV		AL,0x13	
   381 00000774                                 ;		MOV		AH,0x00
   382 00000774                                 ;		INT		0x10
   383 00000774                                 ;		MOV		BYTE [VMODE],8
   384 00000774                                 ;		MOV		WORD [SCRNX],320
   385 00000774                                 ;		MOV		WORD [SCRNY],240
   386 00000774                                 ;		MOV		DWORD [VRAM],000A0000H
   387 00000774                                 ;		JMP		keystatus
   388 00000774                                 ;
   389 00000774                                 scrn640:
   390 00000774                                 ; 画面モードを設定
   391 00000774                                 
   392 00000774 B4 00                           		MOV		AH, 00H
   393 00000776 B0 13                           		MOV		AL, 13H			; VGAグラフィックス、13H：640×480 256色
   394 00000778 CD 10                           		INT		10H
   395 0000077A C6 06 05F2 10                   		MOV		BYTE [VMODE],16
   396 0000077F C7 06 05F4 0280                 		MOV		WORD [SCRNX],640
   397 00000785 C7 06 05F6 01E0                 		MOV		WORD [SCRNY],480
   398 0000078B 66 C7 06 05F8 000A0000          		MOV		DWORD [VRAM],000A0000H
   399 00000794                                 
   400 00000794                                 keystatus:
   401 00000794                                 
   402 00000794                                 
   403 00000794 B4 02                           		MOV		AH,02H
   404 00000796 CD 16                           		INT		16H			; keyboard BIOS
   405 00000798                                 ;H->L:Ins、Caps Lock、Num Lock、Scroll Lock、Alt、Ctrl、Left Shift、Right Shift
   406 00000798 A2 05F1                         		MOV		[LEDS],AL  ; 05f1
   407 0000079B                                 
   408 0000079B                                 ; PICが一切の割り込みを受け付けないようにする
   409 0000079B                                 ;	AT互換機の仕様では、PICの初期化をするなら、
   410 0000079B                                 ;	こいつをCLI前にやっておかないと、たまにハングアップする
   411 0000079B                                 ;	PICの初期化はあとでやる
   412 0000079B                                 
   413 0000079B B0 FF                           		MOV		AL,0xff
   414 0000079D E6 21                           		OUT		0x21,AL
   415 0000079F 90                              		NOP						; OUT命令を連続させるとうまくいかない機種があるらしいので
   416 000007A0 E6 A1                           		OUT		0xa1,AL
   417 000007A2                                 
   418 000007A2 FA                              		CLI						; さらにCPUレベルでも割り込み禁止
   419 000007A3                                 
   420 000007A3                                 ; CPUから1MB以上のメモリにアクセスできるように、A20GATEを設定
   421 000007A3                                 
   422 000007A3 E4 92                                          IN  AL , 92H
   423 000007A5 0C 02                                          OR  AL , 02H     ; enable A20
   424 000007A7 E6 92                                          OUT 92H, AL
   425 000007A9                                 
   426 000007A9                                 
   427 000007A9                                 
   428 000007A9                                 ; プロテクトモード移行
   429 000007A9                                 
   430 000007A9                                 
   431 000007A9 0F 01 16 088A                   		LGDT	[GDTR0]			; 暫定GDTを設定
   432 000007AE 0F 20 C0                        		MOV		EAX,CR0
   433 000007B1 66 25 7FFFFFFF                  		AND		EAX,0x7fffffff	; bit31を0にする（ページング禁止のため）
   434 000007B7 66 83 C8 01                     		OR		EAX,0x00000001	; bit0を1にする（プロテクトモード移行のため）
   435 000007BB 0F 22 C0                        		MOV		CR0,EAX
   436 000007BE EB 00                           		JMP		pipelineflush
   437 000007C0                                 pipelineflush:
   438 000007C0 B8 0008                         		MOV		AX,1*8			;  読み書き可能セグメント32bit
   439 000007C3 8E D8                           		MOV		DS,AX
   440 000007C5 8E C0                           		MOV		ES,AX
   441 000007C7 8E E0                           		MOV		FS,AX
   442 000007C9 8E E8                           		MOV		GS,AX
   443 000007CB 8E D0                           		MOV		SS,AX
   444 000007CD                                 
   445 000007CD                                 ; bootpackの転送
   446 000007CD                                 
   447 000007CD 66 BE 00000890                  		MOV		ESI,bootpack	; 転送元
   448 000007D3 66 BF 00280000                  		MOV		EDI,BOTPAK	; 転送先 0x00280000
   449 000007D9 66 B9 00020000                  		MOV		ECX,512*1024/4
   450 000007DF E8 006E                         		CALL	memcpy
   451 000007E2                                 
   452 000007E2                                 ; ついでにディスクデータも本来の位置へ転送
   453 000007E2                                 
   454 000007E2                                 ; まずはブートセクタから
   455 000007E2                                 
   456 000007E2 66 BE 00000700                  		MOV		ESI,0700H	; 転送元
   457 000007E8 66 BF 00100000                  		MOV		EDI,DSKCAC	; 転送先 0x00100000
   458 000007EE 66 B9 00000080                  		MOV		ECX,512/4
   459 000007F4 E8 0059                         		CALL	memcpy
   460 000007F7                                 
   461 000007F7                                 ; 残り全部
   462 000007F7                                 
   463 000007F7 66 BE 00000B00                  		MOV		ESI,DSKCAC0+512	; 転送元 0x00008000 0x00000900
   464 000007FD 66 BF 00100200                  		MOV		EDI,DSKCAC +512	; 転送先 0x00100000
   465 00000803 66 B9 00000000                  		MOV		ECX,0
   466 00000809 8A 0E 05F0                      		MOV		CL,BYTE [CYLS]
   467 0000080D 66 69 C9 00001200               		IMUL	ECX,512*18*2/4	; シリンダ数からバイト数/4に変換
   468 00000814 66 81 E9 00000080               		SUB		ECX,512/4		; IPLの分だけ差し引く
   469 0000081B E8 0032                         		CALL	memcpy
   470 0000081E                                 
   471 0000081E                                 ; asmheadでしなければいけないことは全部し終わったので、
   472 0000081E                                 ;	あとはbootpackに任せる
   473 0000081E                                 
   474 0000081E                                 ; bootpackの起動
   475 0000081E                                 
   476 0000081E 66 BB 00280000                  		MOV		EBX,BOTPAK              ; 0x00280000
   477 00000824 67 66 8B 4B 10                  		MOV		ECX,[EBX+16]
   478 00000829 66 83 C1 03                     		ADD		ECX,3			; ECX += 3;
   479 0000082D 66 C1 E9 02                     		SHR		ECX,2			; ECX /= 4;
   480 00000831 74 10                           		JZ		skip			; 転送するべきものがない
   481 00000833 67 66 8B 73 14                  		MOV		ESI,[EBX+20]	; 転送元
   482 00000838 66 01 DE                        		ADD		ESI,EBX
   483 0000083B 67 66 8B 7B 0C                  		MOV		EDI,[EBX+12]	; 転送先
   484 00000840 E8 000D                         		CALL	memcpy
   485 00000843                                 skip:
   486 00000843 67 66 8B 63 0C                  		MOV		ESP,[EBX+12]	; スタック初期値
   487 00000848 66 EA 0000001B 0010             		JMP		DWORD 2*8:0x0000001b
   488 00000850                                 
   489 00000850                                 ; waitkbdout:
   490 00000850                                 ; 		IN		 AL,64H
   491 00000850                                 ; 		AND		 AL,02H
   492 00000850                                 ; 		JNZ		waitkbdout		; ANDの結果が0でなければwaitkbdoutへ
   493 00000850                                 ; 		RET
   494 00000850                                 
   495 00000850                                 
   496 00000850                                 memcpy:
   497 00000850 67 66 8B 06                     		MOV		EAX,[ESI]
   498 00000854 66 83 C6 04                     		ADD		ESI,4
   499 00000858 67 66 89 07                     		MOV		[EDI],EAX
   500 0000085C 66 83 C7 04                     		ADD		EDI,4
   501 00000860 66 83 E9 01                     		SUB		ECX,1
   502 00000864 75 EA                           		JNZ		memcpy			; 引き算した結果が0でなければmemcpyへ
   503 00000866 C3                              		RET
   504 00000867                                 ; memcpyはアドレスサイズプリフィクスを入れ忘れなければ、ストリング命令でも書ける
   505 00000867                                 
   506 00000867                                 
   507 00000867                                 ;fin:
   508 00000867                                 ;		HLT
   509 00000867                                 ;		JMP		fin
   510 00000867                                 
   511 00000867                                 
   512 00000867 00 00 00 00 00 00 00 00 00      		ALIGNB	16
   513 00000870                                 GDT0:
   514 00000870 00000000 00000000               		DD 00000000H, 00000000H
   515 00000878 0000FFFF 00CF9200               		DD 0000FFFFH, 00CF9200H
   516 00000880 0000FFFF 00479A28               		DD 0000FFFFH, 00479A28H
   517 00000888                                 
   518 00000888                                 
   519 00000888                                 
   520 00000888 0000                            		DW		0
   521 0000088A                                 GDTR0:
   522 0000088A 0017                            		DW		8*3-1 ; limit 8 * n - 1
   523 0000088C 00000870                        		DD		GDT0  ; base
   524 00000890                                 
   525 00000890                                 		ALIGNB	16
   526 00000890                                 bootpack:
