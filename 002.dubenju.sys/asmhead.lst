     1 00000000                                 ; asm head
     2 00000000                                 ; TAB=4
     3 00000000                                 
     4 00000000                                 [INSTRSET "i486p"]                      ; 486の命令まで使いたいという記述
     5 00000000                                 
     6  = 00000111                              VBEMODE EQU 0x111
     7 00000000                                 ;  0x100 :  640 x  400 x 8bit Color
     8 00000000                                 ;  0x101 :  640 x  480 x 8bit Color
     9 00000000                                 ;  0x103 :  800 x  600 x 8bit Color
    10 00000000                                 ;  0x105 : 1024 x  768 x 8bit Color
    11 00000000                                 ;  0x107 : 1280 x 1024 x 8bit Color
    12 00000000                                 
    13 00000000                                 ;  0x111 :  640 x  480 x 16bit Color5:6:5
    14 00000000                                 ;  0x112 :  640 x  480 x 24bit Color8:8:8
    15 00000000                                 ;  0x114 :  800 x  600 x 16bit Color5:6:5
    16 00000000                                 ;  0x115 :  800 x  600 x 24bit Color8:8:8
    17 00000000                                 ;  0x117 : 1024 x  768 x 16bit Color5:6:5
    18 00000000                                 ;  0x118 : 1024 x  768 x 24bit Color8:8:8
    19 00000000                                 ;  0x11A : 1280 x 1024 x 16bit Color5:6:5
    20 00000000                                 ;  0x11B : 1280 x 1024 x 24bit Color8:8:8
    21 00000000                                 
    22 00000000                                 ;#00083
    23 00000000                                 ;Values for VESA video mode:
    24 00000000                                 ; 00h-FFh OEM video modes (see #00010 at AH=00h)
    25 00000000                                 ; 100h  640x400x256
    26 00000000                                 ; 101h  640x480x256
    27 00000000                                 ; 102h  800x600x16
    28 00000000                                 ; 103h  800x600x256
    29 00000000                                 ; 104h  1024x768x16
    30 00000000                                 ; 105h  1024x768x256
    31 00000000                                 ; 106h  1280x1024x16
    32 00000000                                 ; 107h  1280x1024x256
    33 00000000                                 ; 108h  80x60 text
    34 00000000                                 ; 109h  132x25 text
    35 00000000                                 ; 10Ah  132x43 text
    36 00000000                                 ; 10Bh  132x50 text
    37 00000000                                 ; 10Ch  132x60 text
    38 00000000                                 ;---VBE v1.2+ ---
    39 00000000                                 ; 10Dh  320x200x32K
    40 00000000                                 ; 10Eh  320x200x64K
    41 00000000                                 ; 10Fh  320x200x16M
    42 00000000                                 ; 110h  640x480x32K
    43 00000000                                 ; 111h  640x480x64K
    44 00000000                                 ; 112h  640x480x16M
    45 00000000                                 ; 113h  800x600x32K
    46 00000000                                 ; 114h  800x600x64K
    47 00000000                                 ; 115h  800x600x16M
    48 00000000                                 ; 116h  1024x768x32K
    49 00000000                                 ; 117h  1024x768x64K
    50 00000000                                 ; 118h  1024x768x16M
    51 00000000                                 ; 119h  1280x1024x32K (1:5:5:5)
    52 00000000                                 ; 11Ah  1280x1024x64K (5:6:5)
    53 00000000                                 ; 11Bh  1280x1024x16M
    54 00000000                                 ;---VBE 2.0+ ---
    55 00000000                                 ; 120h  1600x1200x256
    56 00000000                                 ; 121h  1600x1200x32K
    57 00000000                                 ; 122h  1600x1200x64K
    58 00000000                                 
    59 00000000                                 ;81FFh  special full-memory access mode
    60 00000000                                 ;Notes: the special mode 81FFh preserves the contents of the video memory and
    61 00000000                                 ;       gives access to all of the memory; VESA recommends that the special
    62 00000000                                 ;       mode be a packed-pixel mode. For VBE 2.0+, it is required that the
    63 00000000                                 ;       VBE implement the mode, but not place it in the list of available
    64 00000000                                 ;       modes (mode information for this mode can be queried directly, however).
    65 00000000                                 ;       as of VBE 2.0, VESA will no longer define video mode numbers
    66 00000000                                 
    67 00000000                                 
    68  = 00280000                              BOTPAK  EQU     0x00280000      ; bootpackのロード先
    69  = 00100000                              DSKCAC  EQU     0x00100000      ; disk cacheの場所
    70  = 00000600                              DSKCAC0 EQU     0x00000600      ; disk cacheの場所（リアルモード）
    71 00000000                                 
    72 00000000                                 ; BOOT_INFO関係
    73  = 000005F0                              CYLS    EQU     0x05f0          ; ブートセクタが設定する
    74  = 000005F1                              LEDS    EQU     0x05f1          ; 
    75  = 000005F2                              VMODE   EQU     0x05f2          ; 色数に関する情報。何ビットカラーか？
    76  = 000005F4                              SCRNX   EQU     0x05f4          ; 解像度のX
    77  = 000005F6                              SCRNY   EQU     0x05f6          ; 解像度のY
    78  = 000005F8                              VRAM    EQU     0x05f8          ; グラフィックバッファの開始番地
    79 00000000                                 
    80                                                  ORG     0x7F00
    81 00007F00 C6 06 05F0 01                           MOV     BYTE  [CYLS],1 
    82 00007F05                                 
    83 00007F05                                 ;INT 10 - VESA SuperVGA BIOS (VBE) - GET SuperVGA INFORMATION
    84 00007F05                                 ;	AX = 4F00h
    85 00007F05                                 ;	ES:DI -> buffer for SuperVGA information (see #00077)
    86 00007F05                                 ;Return: AL = 4Fh if function supported
    87 00007F05                                 ;	AH = status
    88 00007F05                                 ;	    00h successful
    89 00007F05                                 ;		ES:DI buffer filled
    90 00007F05                                 ;	    01h failed
    91 00007F05                                 ;	    ---VBE v2.0---
    92 00007F05                                 ;	    02h function not supported by current hardware configuration
    93 00007F05                                 ;	    03h function invalid in current video mode
    94 00007F05                                 ;Desc:	determine whether VESA BIOS extensions are present and the capabilities
    95 00007F05                                 ;	  supported by the display adapter
    96 00007F05                                 ;SeeAlso: AX=4E00h,AX=4F01h,AX=7F00h"SOLLEX",AX=A00Ch
    97 00007F05                                 ;Index:	installation check;VESA SuperVGA
    98 00007F05                                 
    99 00007F05                                 
   100 00007F05                                 ;#00077
   101 00007F05                                 ;Format of SuperVGA information:
   102 00007F05                                 ;Offset	Size	Description	)
   103 00007F05                                 ; 00h  4 BYTEs	(ret) signature ("VESA")
   104 00007F05                                 ;		(call) VESA 2.0 request signature ("VBE2"), required to receive
   105 00007F05                                 ;		  version 2.0 info
   106 00007F05                                 ; 04h	WORD	VESA version number (one-digit minor version -- 0102h = v1.2)
   107 00007F05                                 ; 06h	DWORD	pointer to OEM name
   108 00007F05                                 ;		"761295520" for ATI
   109 00007F05                                 ; 0Ah	DWORD	capabilities flags (see #00078)
   110 00007F05                                 ; 0Eh	DWORD	pointer to list of supported VESA and OEM video modes
   111 00007F05                                 ;		(list of words terminated with FFFFh)
   112 00007F05                                 ; 12h	WORD	total amount of video memory in 64K blocks
   113 00007F05                                 ;---VBE v1.x ---
   114 00007F05                                 ; 14h 236 BYTEs	reserved
   115 00007F05                                 ;---VBE v2.0 ---
   116 00007F05                                 ; 14h	WORD	OEM software version (BCD, high byte = major, low byte = minor)
   117 00007F05                                 ; 16h	DWORD	pointer to vendor name
   118 00007F05                                 ; 1Ah	DWORD	pointer to product name
   119 00007F05                                 ; 1Eh	DWORD	pointer to product revision string
   120 00007F05                                 ; 22h	WORD	(if capabilities bit 3 set) VBE/AF version (BCD)
   121 00007F05                                 ;		0100h for v1.0P
   122 00007F05                                 ; 24h	DWORD	(if capabilities bit 3 set) pointer to list of supported
   123 00007F05                                 ;		  accelerated video modes (list of words terminated with FFFFh)
   124 00007F05                                 ; 28h 216 BYTEs	reserved for VBE implementation
   125 00007F05                                 ;100h 256 BYTEs	OEM scratchpad (for OEM strings, etc.)
   126 00007F05                                 ;Notes:	the list of supported video modes is stored in the reserved portion of
   127 00007F05                                 ;	  the SuperVGA information record by some implementations, and it may
   128 00007F05                                 ;	  thus be necessary to either copy the mode list or use a different
   129 00007F05                                 ;	  buffer for all subsequent VESA calls
   130 00007F05                                 ;	not all of the video modes in the list of mode numbers may be
   131 00007F05                                 ;	  supported, e.g. if they require more memory than currently installed
   132 00007F05                                 ;	  or are not supported by the attached monitor.	 Check any mode you
   133 00007F05                                 ;	  intend to use through AX=4F01h first.
   134 00007F05                                 ;	the 1.1 VESA document specifies 242 reserved bytes at the end, so the
   135 00007F05                                 ;	  buffer should be 262 bytes to ensure that it is not overrun; for
   136 00007F05                                 ;	  v2.0, the buffer should be 512 bytes
   137 00007F05                                 ;	the S3 specific video modes will most likely follow the FFFFh
   138 00007F05                                 ;	  terminator at the end of the standard modes.	A search must then
   139 00007F05                                 ;	  be made to find them, FFFFh will also terminate this second list
   140 00007F05                                 ;	in some cases, only a "stub" VBE may be present, supporting only
   141 00007F05                                 ;	  AX=4F00h; this case may be assumed if the list of supported video
   142 00007F05                                 ;	  modes is empty (consisting of a single word of FFFFh)
   143 00007F05                                 
   144 00007F05                                 
   145 00007F05 B8 9000                                 MOV		AX,9000H
   146 00007F08 8E C0                                   MOV		ES,AX
   147 00007F0A BF 0000                                 MOV		DI,0000H
   148 00007F0D                                 ;Check VESA
   149 00007F0D B8 4F00                                 MOV     AX,4F00H                ; Get VESA mode information
   150 00007F10 CD 10                                   INT     10H
   151 00007F12 3D 004F                                 CMP     AX,004FH
   152 00007F15                                 ;		JNE		scrn320
   153 00007F15 75 52                                   JNE     scrn640 ; <>
   154 00007F17                                 
   155 00007F17                                 ;successful
   156 00007F17                                 
   157 00007F17 26 8B 45 04                             MOV     AX,[ES:DI+04H]          ; VESA version number
   158 00007F1B 3D 0200                                 CMP     AX,0200H
   159 00007F1E                                 ;		JB		scrn320
   160 00007F1E 72 49                                   JB      scrn640                 ; < 2.00
   161 00007F20                                 
   162 00007F20                                 ;INT 10 - VESA SuperVGA BIOS - GET SuperVGA MODE INFORMATION
   163 00007F20                                 ;
   164 00007F20                                 ;	AX = 4F01h
   165 00007F20                                 ;	CX = SuperVGA video mode (see #04082 for bitfields)
   166 00007F20                                 ;	ES:DI -> 256-byte buffer for mode information (see #00079)
   167 00007F20                                 ;Return: AL = 4Fh if function supported
   168 00007F20                                 ;	AH = status
   169 00007F20                                 ;	    00h successful
   170 00007F20                                 ;		ES:DI buffer filled
   171 00007F20                                 ;	    01h failed
   172 00007F20                                 ;Desc:	determine the attributes of the specified video mode
   173 00007F20                                 
   174 00007F20                                 ;#04082
   175 00007F20                                 ;Bitfields for VESA/VBE video mode number:
   176 00007F20                                 ;Bit(s)	Description	)
   177 00007F20                                 ; 15	preserve display memory on mode change
   178 00007F20                                 ; 14	(VBE v2.0+) use linear (flat) frame buffer
   179 00007F20                                 ; 13	(VBE/AF 1.0P) VBE/AF initializes accelerator hardware
   180 00007F20                                 ; 12	reserved for VBE/AF
   181 00007F20                                 ; 11	(VBE v3.0) user user-specified CRTC refresh rate values
   182 00007F20                                 ; 10-9	reserved for future expansion
   183 00007F20                                 ; 8-0	video mode number (0xxh are non-VESA modes, 1xxh are VESA-defined)
   184 00007F20                                 
   185 00007F20                                 ;#00079
   186 00007F20                                 ;Format of VESA SuperVGA mode information:
   187 00007F20                                 ;Offset	Size	Description	)
   188 00007F20                                 ; 00h	WORD	mode attributes (see #00080)
   189 00007F20                                 ; 02h	BYTE	window attributes, window A (see #00081)
   190 00007F20                                 ; 03h	BYTE	window attributes, window B (see #00081)
   191 00007F20                                 ; 04h	WORD	window granularity in KB
   192 00007F20                                 ; 06h	WORD	window size in KB
   193 00007F20                                 ; 08h	WORD	start segment of window A (0000h if not supported)
   194 00007F20                                 ; 0Ah	WORD	start segment of window B (0000h if not supported)
   195 00007F20                                 ; 0Ch	DWORD	-> FAR window positioning function (equivalent to AX=4F05h)
   196 00007F20                                 ; 10h	WORD	bytes per scan line
   197 00007F20                                 ;---remainder is optional for VESA modes in v1.0/1.1, needed for OEM modes---
   198 00007F20                                 ; 12h	WORD	width in pixels (graphics) or characters (text)
   199 00007F20                                 ; 14h	WORD	height in pixels (graphics) or characters (text)
   200 00007F20                                 ; 16h	BYTE	width of character cell in pixels
   201 00007F20                                 ; 17h	BYTE	height of character cell in pixels
   202 00007F20                                 ; 18h	BYTE	number of memory planes
   203 00007F20                                 ; 19h	BYTE	number of bits per pixel
   204 00007F20                                 ; 1Ah	BYTE	number of banks
   205 00007F20                                 ; 1Bh	BYTE	memory model type (see #00082)
   206 00007F20                                 ; 1Ch	BYTE	size of bank in KB
   207 00007F20                                 ; 1Dh	BYTE	number of image pages (less one) that will fit in video RAM
   208 00007F20                                 ; 1Eh	BYTE	reserved (00h for VBE 1.0-2.0, 01h for VBE 3.0)
   209 00007F20                                 ;---VBE v1.2+ ---
   210 00007F20                                 ; 1Fh	BYTE	red mask size
   211 00007F20                                 ; 20h	BYTE	red field position
   212 00007F20                                 ; 21h	BYTE	green mask size
   213 00007F20                                 ; 22h	BYTE	green field size
   214 00007F20                                 ; 23h	BYTE	blue mask size
   215 00007F20                                 ; 24h	BYTE	blue field size
   216 00007F20                                 ; 25h	BYTE	reserved mask size
   217 00007F20                                 ; 26h	BYTE	reserved mask position
   218 00007F20                                 ; 27h	BYTE	direct color mode info
   219 00007F20                                 ;		bit 0: color ramp is programmable
   220 00007F20                                 ;		bit 1: bytes in reserved field may be used by application
   221 00007F20                                 ;---VBE v2.0+ ---
   222 00007F20                                 ; 28h	DWORD	physical address of linear video buffer
   223 00007F20                                 ; 2Ch	DWORD	pointer to start of offscreen memory
   224 00007F20                                 ; 30h	WORD	KB of offscreen memory
   225 00007F20                                 ;---VBE v3.0 ---
   226 00007F20                                 ; 32h	WORD	bytes per scan line in linear modes
   227 00007F20                                 ; 34h	BYTE	number of images (less one) for banked video modes
   228 00007F20                                 ; 35h	BYTE	number of images (less one) for linear video modes
   229 00007F20                                 ; 36h	BYTE	linear modes: size of direct color red mask (in bits)
   230 00007F20                                 ; 37h	BYTE	linear modes: bit position of red mask LSB (e.g. shift count)
   231 00007F20                                 ; 38h	BYTE	linear modes: size of direct color green mask (in bits)
   232 00007F20                                 ; 39h	BYTE	linear modes: bit position of green mask LSB (e.g. shift count)
   233 00007F20                                 ; 3Ah	BYTE	linear modes: size of direct color blue mask (in bits)
   234 00007F20                                 ; 3Bh	BYTE	linear modes: bit position of blue mask LSB (e.g. shift count)
   235 00007F20                                 ; 3Ch	BYTE	linear modes: size of direct color reserved mask (in bits)
   236 00007F20                                 ; 3Dh	BYTE	linear modes: bit position of reserved mask LSB
   237 00007F20                                 ; 3Eh	DWORD	maximum pixel clock for graphics video mode, in Hz
   238 00007F20                                 ; 42h 190 BYTEs	reserved (0)
   239 00007F20                                 ;Note:	while VBE 1.1 and higher will zero out all unused bytes of the buffer,
   240 00007F20                                 ;	  v1.0 did not, so applications that want to be backward compatible
   241 00007F20                                 ;	  should clear the buffer before calling
   242 00007F20                                 
   243 00007F20                                 
   244 00007F20 B9 0111                                 MOV     CX, VBEMODE
   245 00007F23 B8 4F01                                 MOV     AX, 4F01H               ; Get VESA mode information
   246 00007F26 CD 10                                   INT     10H
   247 00007F28 3D 004F                                 CMP     AX, 004FH
   248 00007F2B                                 ;		JNE		scrn320
   249 00007F2B 75 3C                                   JNE     scrn640                 ; <>
   250 00007F2D                                 
   251 00007F2D                                 ; successful
   252 00007F2D                                 
   253 00007F2D                                 ;;		CMP		BYTE [ES:DI+0x19], 08H  ; number of bits per pixel
   254 00007F2D                                 ;        CMP     BYTE [ES:DI+0x19], 10H  ; number of bits per pixel
   255 00007F2D                                 ;;		JNE		scrn320
   256 00007F2D                                 ;        JNE     fin
   257 00007F2D                                 ;        JNE     scrn640                 ; <> 16 bit
   258 00007F2D                                 
   259 00007F2D                                 ;#00082
   260 00007F2D                                 ;Values for VESA SuperVGA memory model type:
   261 00007F2D                                 ; 00h	text
   262 00007F2D                                 ; 01h	CGA graphics
   263 00007F2D                                 ; 02h	HGC graphics
   264 00007F2D                                 ; 03h	16-color (EGA) graphics
   265 00007F2D                                 ; 04h	packed pixel graphics
   266 00007F2D                                 ; 05h	"sequ 256" (non-chain 4) graphics
   267 00007F2D                                 ; 06h	direct color (HiColor, 24-bit color)
   268 00007F2D                                 ; 07h	YUV (luminance-chrominance, also called YIQ)
   269 00007F2D                                 ; 08h-0Fh reserved for VESA
   270 00007F2D                                 ; 10h-FFh OEM memory models
   271 00007F2D                                 
   272 00007F2D                                 ;		CMP		BYTE [ES:DI+0x1b],04H   ; memory model type (see #00082)
   273 00007F2D 26 80 7D 1B 06                  		CMP		BYTE [ES:DI+0x1b],06H
   274 00007F32                                 ;		JNE		scrn320
   275 00007F32 75 35                           		JNE		scrn640 ; <> 06h
   276 00007F34                                 
   277 00007F34                                 ;#00080
   278 00007F34                                 ;Bitfields for VESA SuperVGA mode attributes:
   279 00007F34                                 ;Bit(s)	Description	)
   280 00007F34                                 ; 0	mode supported by present hardware configuration
   281 00007F34                                 ; 1	optional information available (must be =1 for VBE v1.2+)
   282 00007F34                                 ; 2	BIOS output supported
   283 00007F34                                 ; 3	set if color, clear if monochrome
   284 00007F34                                 ; 4	set if graphics mode, clear if text mode
   285 00007F34                                 ;---VBE v2.0+ ---
   286 00007F34                                 ; 5	mode is not VGA-compatible
   287 00007F34                                 ; 6	bank-switched mode not supported
   288 00007F34                                 ; 7	linear framebuffer mode supported
   289 00007F34                                 ; 8	double-scan mode available (e.g. 320x200 and 320x240)
   290 00007F34                                 ;---VBE v3.0 ---
   291 00007F34                                 ; 9	interlaced mode available
   292 00007F34                                 ; 10	hardware supports triple buffering
   293 00007F34                                 ; 11	hardware supports stereoscopic display
   294 00007F34                                 ; 12	dual display start address support
   295 00007F34                                 ; 13-15	reserved
   296 00007F34                                 ;---VBE/AF v1.0P---
   297 00007F34                                 ; 9	application must call EnableDirectAccess before calling bank-switching
   298 00007F34                                 ;	  functions
   299 00007F34                                 
   300 00007F34 26 8B 05                        		MOV		AX,[ES:DI+00H]          ; mode attributes (see #00080)
   301 00007F37 25 0080                         		AND		AX,0080H                ; linear framebuffer mode supported
   302 00007F3A                                 ;		JZ		scrn320
   303 00007F3A 74 2D                           		JZ		scrn640
   304 00007F3C                                 
   305 00007F3C                                 
   306 00007F3C 26 8A 45 19                             MOV     AL, [ES:DI+0x19]        ; number of bits per pixel Color depth
   307 00007F40 A2 05F2                                 MOV     [VMODE], AL
   308 00007F43 26 8B 45 12                             MOV     AX, [ES:DI+0x12]  ; width in pixels (graphics) or characters (text)
   309 00007F47 A3 05F4                                 MOV     [SCRNX], AX
   310 00007F4A 26 8B 45 14                             MOV     AX,[ES:DI+0x14]  ; height in pixels (graphics) or characters (text)
   311 00007F4E A3 05F6                                 MOV     [SCRNY],AX
   312 00007F51 66 26 8B 45 28                          MOV     EAX, [ES:DI+0x28] ; physical address of linear video buffer
   313 00007F56 66 A3 05F8                              MOV     [VRAM], EAX
   314 00007F5A                                 ;       JMP     fin
   315 00007F5A                                 
   316 00007F5A                                 ;INT 10 - VESA SuperVGA BIOS - SET SuperVGA VIDEO MODE
   317 00007F5A                                 ;
   318 00007F5A                                 ;	AX = 4F02h
   319 00007F5A                                 ;	BX = new video mode (see #04082,#00083,#00084)
   320 00007F5A                                 ;	ES:DI -> (VBE 3.0+) CRTC information block, bit mode bit 11 set
   321 00007F5A                                 ;		  (see #04083)
   322 00007F5A                                 ;Return: AL = 4Fh if function supported
   323 00007F5A                                 ;	AH = status
   324 00007F5A                                 ;	    00h successful
   325 00007F5A                                 ;	    01h failed
   326 00007F5A                                 ;Notes:	bit 13 may only be set if the video mode is present in the list of
   327 00007F5A                                 ;	  accelerated video modes returned by AX=4F00h
   328 00007F5A                                 ;	if the DAC supports both 8 bits per primary color and 6 bits, it will
   329 00007F5A                                 ;	  be reset to 6 bits after a mode set; use AX=4F08h to restore 8 bits
   330 00007F5A                                 ;SeeAlso: AX=4E03h,AX=4F00h,AX=4F01h,AX=4F03h,AX=4F08h
   331 00007F5A                                 
   332 00007F5A                                 ;#00084
   333 00007F5A                                 ;Values for S3 OEM video mode:
   334 00007F5A                                 ; 201h	640x480x256
   335 00007F5A                                 ; 202h	800x600x16
   336 00007F5A                                 ; 203h	800x600x256
   337 00007F5A                                 ; 204h	1024x768x16
   338 00007F5A                                 ; 205h	1024x768x256
   339 00007F5A                                 ; 206h	1280x960x16
   340 00007F5A                                 ; 207h	1152x864x256 (Diamond Stealth 64)
   341 00007F5A                                 ; 208h	1280x1024x16
   342 00007F5A                                 ; 209h	1152x864x32K
   343 00007F5A                                 ; 20Ah	1152x864x64K (Diamond Stealth 64)
   344 00007F5A                                 ; 20Bh	1152x864x4G
   345 00007F5A                                 ; 211h	640x480x64K (Diamond Stealth 24)
   346 00007F5A                                 ; 211h	640x400x4G  (Diamond Stealth64 Video / Stealth64 Graphics)
   347 00007F5A                                 ; 212h	640x480x16M (Diamond Stealth 24)
   348 00007F5A                                 ; 301h	640x480x32K
   349 00007F5A                                 ;Note:	these modes are only available on video cards using S3's VESA driver
   350 00007F5A                                 ;SeeAlso: #00083,#00191,#00732 at INT 1A/AX=B102h
   351 00007F5A                                 ;Index:	video modes;S3
   352 00007F5A                                 
   353 00007F5A                                 ; Input: BX = 
   354 00007F5A                                 ; Bits 0-13 mode number; 
   355 00007F5A                                 ; bit 14 is the LFB bit: when set, it enables the linear framebuffer, when clear, software must use bank switching. 
   356 00007F5A                                 ; Bit 15 is the DM bit: when set, the BIOS doesn't clear the screen. Bit 15 is usually ignored and should always be cleared.
   357 00007F5A BB 4111                                 MOV     BX, VBEMODE + 4000H
   358 00007F5D B8 4F02                                 MOV     AX,4F02H                ; Set VBE mode
   359 00007F60 CD 10                                   INT     10H
   360 00007F62 3D 004F                                 CMP     AX, 004FH
   361 00007F65                                 ;		JNE		fin
   362 00007F65 75 02                                   JNE     scrn640                 ; ★
   363 00007F67                                 
   364 00007F67                                 ;#04083
   365 00007F67                                 ;Format of VESA VBE CRTC Information Block:
   366 00007F67                                 ;Offset	Size	Description	)
   367 00007F67                                 ; 00h	WORD	total number of pixels horizontally
   368 00007F67                                 ; 02h	WORD	horizontal sync start (in pixels)
   369 00007F67                                 ; 04h	WORD	horizontal sync end (in pixels)
   370 00007F67                                 ; 06h	WORD	total number of scan lines
   371 00007F67                                 ; 08h	WORD	vertical sync start (in scan lines)
   372 00007F67                                 ; 0Ah	WORD	vertical sync end (in scan lines)
   373 00007F67                                 ; 0Ch	BYTE	flags (see #04084)
   374 00007F67                                 ; 0Dh	DWORD	pixel clock, in Hz
   375 00007F67                                 ; 11h	WORD	refresh rate, in 0.01 Hz units
   376 00007F67                                 ;		this field MUST be set to pixel_clock / (HTotal * VTotal),
   377 00007F67                                 ;		  even though it may not actually be used by the VBE
   378 00007F67                                 ;		  implementation
   379 00007F67                                 ; 13h 40 BYTEs	reserved
   380 00007F67                                 
   381 00007F67                                 
   382 00007F67                                 
   383 00007F67                                 
   384 00007F67                                 
   385 00007F67 EB 20                                   JMP     keystatus
   386 00007F69                                 ;		jmp		fin
   387 00007F69                                 
   388 00007F69                                 ;scrn320:
   389 00007F69                                 ;		MOV		AL,0x13	
   390 00007F69                                 ;		MOV		AH,0x00
   391 00007F69                                 ;		INT		0x10
   392 00007F69                                 ;		MOV		BYTE [VMODE],8
   393 00007F69                                 ;		MOV		WORD [SCRNX],320
   394 00007F69                                 ;		MOV		WORD [SCRNY],240
   395 00007F69                                 ;		MOV		DWORD [VRAM],000A0000H
   396 00007F69                                 ;		JMP		keystatus
   397 00007F69                                 ;
   398 00007F69                                 scrn640:
   399 00007F69                                 ; 画面モードを設定
   400 00007F69                                 
   401 00007F69 B4 00                           		MOV		AH, 00H
   402 00007F6B B0 13                           		MOV		AL, 13H			; VGAグラフィックス、13H：640×480 256色
   403 00007F6D CD 10                           		INT		10H
   404 00007F6F                                 ;		MOV		BYTE [VMODE],16
   405 00007F6F C6 06 05F2 08                   		MOV		BYTE [VMODE],8
   406 00007F74 C7 06 05F4 0280                 		MOV		WORD [SCRNX],640
   407 00007F7A C7 06 05F6 01E0                 		MOV		WORD [SCRNY],480
   408 00007F80 66 C7 06 05F8 000A0000          		MOV		DWORD [VRAM],000A0000H
   409 00007F89                                 ;		JMP		keystatus
   410 00007F89                                 
   411 00007F89                                 
   412 00007F89                                 
   413 00007F89                                 
   414 00007F89                                 keystatus:
   415 00007F89 B4 02                                   MOV     AH,02H
   416 00007F8B CD 16                                   INT     16H                     ; keyboard BIOS
   417 00007F8D                                 ;H->L:Ins、Caps Lock、Num Lock、Scroll Lock、Alt、Ctrl、Left Shift、Right Shift
   418 00007F8D A2 05F1                                 MOV     [LEDS],AL  ; 05f1
   419 00007F90                                 
   420 00007F90                                 ; PICが一切の割り込みを受け付けないようにする
   421 00007F90                                 ;	AT互換機の仕様では、PICの初期化をするなら、
   422 00007F90                                 ;	こいつをCLI前にやっておかないと、たまにハングアップする
   423 00007F90                                 ;	PICの初期化はあとでやる
   424 00007F90                                 
   425 00007F90 B0 FF                                   MOV     AL,0FFH
   426 00007F92 E6 21                                   OUT     21H,AL
   427 00007F94 90                                      NOP                             ; OUT命令を連続させるとうまくいかない機種があるらしいので
   428 00007F95 E6 A1                                   OUT     0A1H,AL
   429 00007F97                                 
   430 00007F97 FA                                      CLI                             ; さらにCPUレベルでも割り込み禁止
   431 00007F98                                 ; CPUから1MB以上のメモリにアクセスできるように、A20GATEを設定
   432 00007F98 E4 92                                   IN  AL , 92H
   433 00007F9A 0C 02                                   OR  AL , 02H     ; enable A20
   434 00007F9C E6 92                                   OUT 92H, AL
   435 00007F9E                                 
   436 00007F9E B9 0002                                                     mov cx, 2
   437 00007FA1                                 ;    push ds
   438 00007FA1                                 ;    push es
   439 00007FA1 B8 0000                                                     mov ax, 0000H
   440 00007FA4 8E C0                                                       mov es, ax
   441 00007FA6 66 BB 00180010                                              mov EBX, 180010H
   442 00007FAC                                 rd_bootpack:
   443 00007FAC                                 ;先选择通道(Primary or Secondary), 并检查硬盘是否忙，忙则等待
   444 00007FAC BA 01F7                                                     mov dx,0x1f7
   445 00007FAF                                      .waitsbp:
   446 00007FAF EC                                                          in  al,dx
   447 00007FB0 24 80                                                       and al,0x80
   448 00007FB2 3C 80                                                       cmp al,0x80
   449 00007FB4 74 F9                                                       jz .waitsbp
   450 00007FB6                                 
   451 00007FB6                                 
   452 00007FB6                                 ;往该通道的sector count寄存器中写入待操作的扇区数
   453 00007FB6 BA 01F2                                                     mov dx,0x1f2
   454 00007FB9 B0 FF                                                       mov al,0FFH;[7C16H] ;bsSECTORS_PER_FATF DW  ;1 个扇区 ??
   455 00007FBB EE                                                          out dx,al
   456 00007FBC                                 
   457 00007FBC                                 ;往该通道上的三个LBA寄存器写入扇区起始地址的低24位
   458 00007FBC                                 ;往device寄存器中写入LBA地址的24~27位, 并置第6位为1(LBA模式), 选择操作的硬盘(master or slave)
   459 00007FBC BA 01F3                                                     mov dx,0x1f3
   460 00007FBF 26 A0 05A0                                                  mov al,[es:05A0H] ;0x02                       ;
   461 00007FC3 EE                                                          OUT DX,AL ;LBA 地址 7～0
   462 00007FC4 42                                                          inc dx ;0x1f4
   463 00007FC5 26 A0 05A1                                                  mov al,[es:05A1H]; 0x00                       ;
   464 00007FC9 EE                                                          OUT DX,AL ;LBA 地址 15～8
   465 00007FCA 42                                                          inc dx ;0x1f5
   466 00007FCB 26 A0 05A2                                                  mov al,[es:05A2H];                    ;
   467 00007FCF EE                                                          OUT DX,AL ;LBA 地址 23～16
   468 00007FD0 42                                                          inc dx ;0x1f6
   469 00007FD1                                                             ;mov al,0xe0 ;LBA模式，主硬盘，以及 LBA 地址 27～24
   470 00007FD1 26 A0 05A3                                                  mov al,[es:05A3H];                    ;
   471 00007FD5 0C F0                                                       OR  AL, 0F0H
   472 00007FD7 24 E0                                                       AND AL, 0E0H
   473 00007FD9 EE                                                          OUT DX,AL
   474 00007FDA                                 ;jmp fin
   475 00007FDA                                 ;往该通道上的command寄存器写入操作命令
   476 00007FDA BA 01F7                                                     mov dx,0x1f7
   477 00007FDD B0 20                                                       mov al,0x20   ;读命令
   478 00007FDF EE                                                          out dx,al
   479 00007FE0                                 
   480 00007FE0                                 ;读取该通道上的status寄存器, 判断硬盘工作是否完成
   481 00007FE0 BA 01F7                                                     mov dx,0x1f7
   482 00007FE3                                      .waits2bp:
   483 00007FE3 EC                                                          in  al,dx
   484 00007FE4 24 80                                                       and al,0x80
   485 00007FE6                                 ;jmp fin
   486 00007FE6                                 ;         cmp al,0x80
   487 00007FE6 75 FB                                                       jnz .waits2bp
   488 00007FE8                                 
   489 00007FE8                                 ;如果以上步骤是读硬盘, 进入下一个步骤。否则, 完工
   490 00007FE8                                 ;将硬盘数据读出DS:BX
   491 00007FE8 51                                                          push cx
   492 00007FE9                                 ;        mov eax, 28000H
   493 00007FE9 66 B8 0000FFFF                                              mov eax, 0FFFFH
   494 00007FEF 8E D8                                                       mov ds, eax
   495 00007FF1                                 ;jmp fin
   496 00007FF1 B8 00FF                                                     mov ax, 0FFH ;[es:7C16H] ;bsSECTORS_PER_FAT
   497 00007FF4                                 ;                            mov EBX, 280000H
   498 00007FF4                                 ;                            MOV EAX, 0BB66AA55H
   499 00007FF4                                 ;                            MOV [ds:EBX], EAX
   500 00007FF4                                 ;jmp fin
   501 00007FF4 BA 01F0                                                     mov dx,0x1f0
   502 00007FF7                                     .readnsbp:
   503 00007FF7 50                                                          push ax
   504 00007FF8 B9 0100                                                     mov cx,256   ;总共要读取的字数
   505 00007FFB                                     .readwbp:
   506 00007FFB ED                                                          in  ax,dx
   507 00007FFC 67 3E 89 03                                                 mov [ds:ebx],ax
   508 00008000 66 83 C3 02                                                 add ebx,2
   509 00008004 E2 F5                                                       loop .readwbp
   510 00008006                                 
   511 00008006 58                                                          pop ax
   512 00008007 48                                                          dec ax
   513 00008008 3D 0000                                                     cmp ax, 00h
   514 0000800B 75 EA                                                       jnz .readnsbp
   515 0000800D                                 ;    jmp fin
   516 0000800D 59                                                          pop cx
   517 0000800E                                 
   518 0000800E 66 26 A1 05A0                                               mov eax, [es:05A0H]
   519 00008013                                 ;jmp fin
   520 00008013 66 05 000000FF                                              ADD eax, 0FFH
   521 00008019 66 26 A3 05A0                                               mov [es:05A0H], eax
   522 0000801E                                 ;jmp fin
   523 0000801E E2 8C                                                       loop rd_bootpack
   524 00008020                                 ;        pop ds
   525 00008020                                 ;        pop es
   526 00008020                                 ;jmp fin
   527 00008020                                 [INSTRSET "i486p"]
   528 00008020 B8 0008                                 MOV		AX,1*8			;  読み書き可能セグメント32bit
   529 00008023 8E D8                                   MOV		DS,AX
   530 00008025 8E C0                                   MOV		ES,AX
   531 00008027 8E E0                                   MOV		FS,AX
   532 00008029 8E E8                                   MOV		GS,AX
   533 0000802B 8E D0                                   MOV		SS,AX
   534 0000802D                                 
   535 0000802D                                 ; プロテクトモード移行
   536 0000802D 0F 01 16 80BA                           LGDT	[GDTR0]			; 暫定GDTを設定
   537 00008032 0F 20 C0                                MOV		EAX,CR0
   538 00008035 66 25 7FFFFFFF                          AND		EAX,0x7fffffff	; bit31を0にする（ページング禁止のため）
   539 0000803B 66 83 C8 01                             OR		EAX,0x00000001	; bit0を1にする（プロテクトモード移行のため）
   540 0000803F 0F 22 C0                                MOV		CR0,EAX
   541 00008042 EB 00                                  JMP		pipelineflush
   542 00008044                                 
   543 00008044                                 pipelineflush:       ; 把除了CS以外的段寄存器值换成0x0008，也就是第一个段。CS放在后面单独处理。
   544 00008044                                 ;        MOV		AX,1*8			;  読み書き可能セグメント32bit
   545 00008044                                 ;        jmp fin 
   546 00008044                                 ;        MOV		DS,AX
   547 00008044                                 ;        MOV		ES,AX
   548 00008044                                 ;        MOV		FS,AX
   549 00008044                                 ;        MOV		GS,AX
   550 00008044                                 ;        MOV		SS,AX
   551 00008044                                 ;        jmp fin 
   552 00008044                                 ; bootpackの転送
   553 00008044                                 
   554 00008044                                 ;        MOV		ESI,bootpack	; 転送元
   555 00008044                                 ;        MOV		EDI,BOTPAK	; 転送先 0x00280000
   556 00008044                                 ;        MOV		ECX,512 * 1024 / 4
   557 00008044                                 ;        CALL	memcpy
   558 00008044                                 
   559 00008044                                 ; ついでにディスクデータも本来の位置へ転送
   560 00008044                                 
   561 00008044                                 ; まずはブートセクタから
   562 00008044                                 
   563 00008044                                 ;        MOV		ESI,0600H	; 転送元 0600-0700
   564 00008044                                 ;        MOV		EDI,DSKCAC	; 転送先 0x00100000
   565 00008044                                 ;        MOV		ECX,512 / 4
   566 00008044                                 ;        CALL	memcpy
   567 00008044                                 ;
   568 00008044                                 ;; 残り全部
   569 00008044                                 ;
   570 00008044                                 ;        MOV     ESI,DSKCAC0+512	; 転送元 0x00000600 0x00000900
   571 00008044                                 ;        MOV     EDI,DSKCAC +512	; 転送先 0x00100000 FAT
   572 00008044                                 ;        MOV     ECX,0
   573 00008044                                 ;        MOV      CL,BYTE [CYLS]
   574 00008044                                 ;        IMUL    ECX,512*18*2/4	; シリンダ数からバイト数/4に変換
   575 00008044                                 ;        SUB     ECX,512/4		; IPLの分だけ差し引く
   576 00008044                                 ;        CALL    memcpy
   577 00008044                                 
   578 00008044                                 
   579 00008044                                 ; asmheadでしなければいけないことは全部し終わったので、
   580 00008044                                 ;	あとはbootpackに任せる
   581 00008044                                 
   582 00008044                                 ; bootpackの起動
   583 00008044 66 BB 00280000                  		MOV		EBX,BOTPAK              ; 0x00280000
   584 0000804A 67 66 8B 4B 10                  		MOV		ECX,[EBX+16]
   585 0000804F 66 83 C1 03                     		ADD		ECX,3			; ECX += 3;
   586 00008053 66 C1 E9 02                     		SHR		ECX,2			; ECX /= 4;
   587 00008057 74 10                           		JZ		skip			; 転送するべきものがない
   588 00008059 67 66 8B 73 14                  		MOV		ESI,[EBX+20]	; 転送元
   589 0000805E 66 01 DE                        		ADD		ESI,EBX
   590 00008061 67 66 8B 7B 0C                  		MOV		EDI,[EBX+12]	; 転送先
   591 00008066 E8 000F                         		CALL	memcpy
   592 00008069                                 ;jmp fin
   593 00008069                                 skip:
   594 00008069 67 66 8B 63 0C                  		MOV		ESP,[EBX+12]	; スタック初期値
   595 0000806E EB 1F                           jmp fin
   596 00008070 66 EA 0000001B 0010             		JMP		DWORD 2*8:0x0000001b 
   597 00008078                                 ; 最后的JMP指令，将CS改成2*8，即第二个段，它所指向的地址是0x00280000，正是bootpack.hrb所在的位置。
   598 00008078                                 ; 0x0000001b是跳过header之后的真正的程序的位置。
   599 00008078                                 ; 切换任务就是执行JMP指令
   600 00008078                                 ; JMP指令分两种，即"只改写EIP的near模式"与"同时改写EIP和CS的far模式"。CS是代码段寄存器(code segment)。
   601 00008078                                 ; 平时使用的都是near模式。
   602 00008078                                 ; 这条指令在向EIP写入0x1b时，也向CS写入2*8（即16）。
   603 00008078                                 ; 像这样在JMP目标地址中带冒号（:）的，就是far模式。
   604 00008078                                 ; 切换任务时，我们使用far模式的JMP指令。
   605 00008078                                 ; CPU执行far模式的JMP指令前，会根据GDT中注册的TSS情况，判断JMP的目标地址是可执行代码还是TSS。
   606 00008078                                 ; 如果是可执行代码，那么CPU就认为这只是一个普通的far模式的JMP；
   607 00008078                                 ; 如果是TSS，则认为这是一个任务切换指令，会切换到目标地址指定的TSS所记录的任务中，也就是JMP到另一个任务那里去了。
   608 00008078                                 ; 所以普通的far模式的JMP和任务切换的JMP指令，其机器码是同一个。
   609 00008078                                 
   610 00008078                                 ; waitkbdout:
   611 00008078                                 ; 		IN		 AL,64H
   612 00008078                                 ; 		AND		 AL,02H
   613 00008078                                 ; 		JNZ		waitkbdout		; ANDの結果が0でなければwaitkbdoutへ
   614 00008078                                 ; 		RET
   615 00008078                                 
   616 00008078                                 
   617 00008078                                 memcpy:
   618 00008078 67 66 8B 06                     		MOV		EAX,[ESI]
   619 0000807C 66 83 C6 04                     		ADD		ESI,4
   620 00008080 67 66 89 07                     		MOV		[EDI],EAX
   621 00008084 66 83 C7 04                     		ADD		EDI,4
   622 00008088 66 83 E9 01                     		SUB		ECX,1
   623 0000808C 75 EA                           		JNZ		memcpy			; 引き算した結果が0でなければmemcpyへ
   624 0000808E C3                              		RET
   625 0000808F                                 ; memcpyはアドレスサイズプリフィクスを入れ忘れなければ、ストリング命令でも書ける
   626 0000808F                                 
   627 0000808F                                 ;READ_SECTOR:
   628 0000808F                                 ;                            MOV AX, 00H
   629 0000808F                                 ;                            MOV DS, AX
   630 0000808F                                 ;                            MOV AH, 42H
   631 0000808F                                 ;                            MOV DL, [7C24H]       ;(DL)=驱动器号
   632 0000808F                                 ;                            MOV SI, [7C40H]
   633 0000808F                                 ;                            INT 13H
   634 0000808F                                 ;jmp fin
   635 0000808F                                 ;RETURN_PRC:
   636 0000808F                                 ;                            RET
   637 0000808F                                 
   638 0000808F                                 fin:
   639 0000808F                                 ;		HLT
   640 0000808F BB 0055                                 MOV BX, 55H
   641 00008092 EB FB                           		JMP		fin
   642 00008094                                 
   643 00008094                                 
   644 00008094 00 00 00 00 00 00 00 00 00 00   		ALIGNB	16
       0000809E 00 00 
   645 000080A0                                 GDT0:
   646 000080A0 00000000 00000000               		DD 00000000H, 00000000H
   647 000080A8 0000FFFF 00CF9200               		DD 0000FFFFH, 00CF9200H
   648 000080B0 0000FFFF 00479A28               		DD 0000FFFFH, 00479A28H
   649 000080B8 0000                            		DW		0
   650 000080BA                                 GDTR0:
   651 000080BA 0017                            		DW		8*3-1 ; limit 8 * n - 1
   652 000080BC 000080A0                        		DD		GDT0  ; base
   653 000080C0                                 
   654 000080C0 00 00 00 00 00 00 00 00 00 00   TIMES 1024 - ( $ - $$) DB 00
       000080CA 00 00 00 00 00 00 00 00 00 00 
       000080D4 00 00 00 00 00 00 00 00 00 00 
       000080DE 00 00 00 00 00 00 00 00 00 00 
       000080E8 00 00 00 00 00 00 00 00 00 00 
       000080F2 00 00 00 00 00 00 00 00 00 00 
       000080FC 00 00 00 00 00 00 00 00 00 00 
       00008106 00 00 00 00 00 00 00 00 00 00 
       00008110 00 00 00 00 00 00 00 00 00 00 
       0000811A 00 00 00 00 00 00 00 00 00 00 
       00008124 00 00 00 00 00 00 00 00 00 00 
       0000812E 00 00 00 00 00 00 00 00 00 00 
       00008138 00 00 00 00 00 00 00 00 00 00 
       00008142 00 00 00 00 00 00 00 00 00 00 
       0000814C 00 00 00 00 00 00 00 00 00 00 
       00008156 00 00 00 00 00 00 00 00 00 00 
       00008160 00 00 00 00 00 00 00 00 00 00 
       0000816A 00 00 00 00 00 00 00 00 00 00 
       00008174 00 00 00 00 00 00 00 00 00 00 
       0000817E 00 00 00 00 00 00 00 00 00 00 
       00008188 00 00 00 00 00 00 00 00 00 00 
       00008192 00 00 00 00 00 00 00 00 00 00 
       0000819C 00 00 00 00 00 00 00 00 00 00 
       000081A6 00 00 00 00 00 00 00 00 00 00 
       000081B0 00 00 00 00 00 00 00 00 00 00 
       000081BA 00 00 00 00 00 00 00 00 00 00 
       000081C4 00 00 00 00 00 00 00 00 00 00 
       000081CE 00 00 00 00 00 00 00 00 00 00 
       000081D8 00 00 00 00 00 00 00 00 00 00 
       000081E2 00 00 00 00 00 00 00 00 00 00 
       000081EC 00 00 00 00 00 00 00 00 00 00 
       000081F6 00 00 00 00 00 00 00 00 00 00 
       00008200 00 00 00 00 00 00 00 00 00 00 
       0000820A 00 00 00 00 00 00 00 00 00 00 
       00008214 00 00 00 00 00 00 00 00 00 00 
       0000821E 00 00 00 00 00 00 00 00 00 00 
       00008228 00 00 00 00 00 00 00 00 00 00 
       00008232 00 00 00 00 00 00 00 00 00 00 
       0000823C 00 00 00 00 00 00 00 00 00 00 
       00008246 00 00 00 00 00 00 00 00 00 00 
       00008250 00 00 00 00 00 00 00 00 00 00 
       0000825A 00 00 00 00 00 00 00 00 00 00 
       00008264 00 00 00 00 00 00 00 00 00 00 
       0000826E 00 00 00 00 00 00 00 00 00 00 
       00008278 00 00 00 00 00 00 00 00 00 00 
       00008282 00 00 00 00 00 00 00 00 00 00 
       0000828C 00 00 00 00 00 00 00 00 00 00 
       00008296 00 00 00 00 00 00 00 00 00 00 
       000082A0 00 00 00 00 00 00 00 00 00 00 
       000082AA 00 00 00 00 00 00 00 00 00 00 
       000082B4 00 00 00 00 00 00 00 00 00 00 
       000082BE 00 00 00 00 00 00 00 00 00 00 
       000082C8 00 00 00 00 00 00 00 00 00 00 
       000082D2 00 00 00 00 00 00 00 00 00 00 
       000082DC 00 00 00 00 00 00 00 00 00 00 
       000082E6 00 00 00 00 00 00 00 00 00 00 
       000082F0 00 00 00 00 00 00 00 00 00 00 
       000082FA 00 00 00 00 00 00 
   655 00008300                                 
   656 00008300                                 		ALIGNB	16
   657 00008300                                 bootpack:
